<!DOCTYPE html>
<head>
  <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
  <title>Coverage for {{project}} - {{path}}</title>
  <meta charset="utf-8">
  <style>
    .coverage-header {
      padding: 5px 10px;
      border-bottom: 1px solid #DBDBDB;
      background-color: #EEE;
      line-height: 24px;
      text-align: center;
      font-weight: bold;
      font-size: 18px;
    }
    table {
      border-collapse: collapse;
      border: 1px solid #EEE;
      font-family: -apple-system, sans-serif;
    }
    td {
      vertical-align: top;
      padding: 2px 8px;
      border-collapse: collapse;
      border-right: solid 1px #EEE;
      border-left: solid 1px #EEE;
      text-align: left;
    }
    tbody td {
      height: 18px;
    }
    td pre {
      margin-top: 0px !important;
      margin-bottom: 0px !important;
      display: inline-block;
      font-family: monospace;
      height: 15px;
    }
    td:first-child {
      border-left: none;
    }
    td:last-child {
      border-right: none;
    }
    thead a:hover {
      background-color: yellow;
    }
    .highlight-row:hover {
      background-color: #F0F0F0;
    }
    .incoverable-code:hover {
      background-color: #F0F0F0;
    }
    .covered-code {
      background-color: #AAF2AA;
    }
    .covered-code:hover {
      background-color: #F0F0F0;
    }
    .uncovered-code {
      background-color: #EF9B9B;
    }
    .uncovered-code:hover {
      background-color: #F0F0F0;
    }
    .covered-count {
      color: GREEN;
      text-align: right;
    }
    .covered-count:hover {
      background-color: #F0F0F0;
    }
    .uncovered-count {
      color: RED;
      text-align: right;
    }
    .uncovered-count:hover {
      background-color: #F0F0F0;
    }
  </style>
  <script src="/bower_components/webcomponentsjs/webcomponents-lite.js"></script>
  <link rel="import" href="/ui/elements/findit-app.html">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script>
    function CheckShowLLVMReport() {
      if ($('#toggle-llvm-report').prop('checked')) {
        if (! $('#llvm-report').attr('src')) {
          $('#llvm-report').attr('src', './coverage/api/get-coverage-file/host/{{host}}/project/{{project}}/revision/{{revision}}/coverage/{{path[2:]}}.html');
        }
        $('#llvm-report').show();
        if (typeof(Storage) !== 'undefined') {
          localStorage.showllvmreport = 'yes';
        }
      } else {
        $('#llvm-report').hide();
        if (typeof(Storage) !== 'undefined') {
          localStorage.showllvmreport = 'no';
        }
      }
    }

    $(function() {
      document.getElementById('app').userInfo = {{ (user_info or {}) | tojson | safe }};

      $('#toggle-llvm-report').click(function() {
        CheckShowLLVMReport();
      });
      if (typeof(Storage) !== 'undefined' && localStorage.showllvmreport === 'yes') {
        $('#toggle-llvm-report').prop('checked', true);
      }
      CheckShowLLVMReport();

      $('#llvm-report').on('load', function() {
        // Keep the two coverage report side by side of the same height.
        document.getElementById('llvm-report').style.height = document.getElementById('report-data-container').offsetHeight + 'px';
      });
    });
  </script>
</head>

<body>
  <findit-app id="app" components="Tools>CodeCoverage" page-header="Code Coverage">
    <div style="font-size:18px">
    Switch to <a href="./coverage?host={{host}}&project={{project}}&revision={{revision}}&path=>>">Component View</a>
    <br>
    <br>
    </div>
    <table>
      <thead>
        <tr class="coverage-header">
          <th colspan="4">
            <a href="./coverage?host={{host}}&project={{project}}">{{project}}</a>
            - {{data.commit_position or revision}}
            - <a href="./coverage?host={{host}}&project={{project}}&revision={{revision}}&path={{path_root}}">{{path_root}}</a>{% for name, sub_path in path_parts %}<a style="padding-left:.3ex;" title="{{sub_path}}" href="./coverage?host={{host}}&project={{project}}&revision={{revision}}&path={{sub_path}}">{{name}}</a>{% endfor %}
          </th>
        </tr>
        <tr>
          <th>Line</th>
          <th>Count</th>
          <th></th>
          {% if user_info.is_admin %}
          <th style="width:100%">
            <input type="checkbox" id="toggle-llvm-report">Compare Metadata-based with llvm-generated HTML Report (For Debugging)
          </th>
          {% endif %}
        </tr>
      </thead>

      <tbody id="report-data-container">
      {% for num, info in data.line_to_data %}
        {% if num > 1 %}
          {% set tr_css_class = "highlight-row" %}
        {% else %}
          {% set tr_css_class = ""%}
        {% endif %}
        <tr class="{{tr_css_class}}">
          <td><a href="#{{num}}"><pre>{{num}}</pre></a></td>
          {% if info.count == 0 %}
          <td class="uncovered-count"><pre>0</pre></td>
          <td class="uncovered-code"><pre>{{info.line}}</pre></td>
          {% elif info.count > 0 %}
            <td class="covered-count" title="{{info.count}}">
              {% if info.count >= 1000000000000 %}
              <pre>{{'{0:.1f}'.format(info.count/1000000000000.0)}}T</pre>
              {% elif info.count >= 1000000000 %}
              <pre>{{'{0:.1f}'.format(info.count/1000000000.0)}}G</pre>
              {% elif info.count >= 1000000 %}
              <pre>{{'{0:.1f}'.format(info.count/1000000.0)}}M</pre>
              {% elif info.count >= 1000 %}
              <pre>{{'{0:.1f}'.format(info.count/1000.0)}}K</pre>
              {% else %}
              <pre>{{info.count}}</pre>
              {% endif %}
            </td>
          <td class="covered-code"><pre>{{info.line}}</pre></td>
          {% else %}
          <td></td>
          <td class="incoverable-code"><pre>{{info.line}}</pre></td>
          {% endif %}
          {% if num == 1 and user_info.is_admin %}
          <td rowspan="{{ data.line_to_data | length}}">
            <iframe src="" id="llvm-report" style="border:0px;display:block;width:100%!important; height:100%!important;"></iframe>
          </td>
          {% endif %}
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </findit-app>
</body>
