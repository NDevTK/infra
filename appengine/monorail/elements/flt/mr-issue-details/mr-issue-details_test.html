<meta charset="utf-8">
<script src="/bower_components/webcomponentsjs/webcomponents-loader.js"></script>
<script src="/bower_components/web-component-tester/browser.js"></script>
<script src="/static/js/autolink.js"></script>
<link rel="import" href="/elements/redux/redux-mixin.html">
<link rel="import" href="/elements/flt/mr-issue-details/mr-issue-details.html">
<test-fixture id="basic">
  <template>
    <mr-issue-details></mr-issue-details>
  </template>
</test-fixture>
<script>
(function() {
  'use strict';

  suite('basic tests', function() {
    let element;

    setup(function() {
      element = fixture('basic');
    });

    test('_updateDescriptionHandler generates description change', function(done) {
      window.actionCreator = {
        updateIssue: sinon.stub(),
      };

      element.token = '1234';
      element.issueId = 5;
      element.projectName = 'chromium';
      element._updateDescriptionHandler({detail: {
          commentContent: 'comment data',
          sendEmail: true,
        }
      });

      flush(() => {
        assert.deepEqual(actionCreator.updateIssue.args[0][1], {
          trace: {token: '1234'},
          issueRef: {
            projectName: 'chromium',
            localId: 5,
          },
          commentContent: 'comment data',
          isDescription: true,
          sendEmail: true,
        });
        assert.isTrue(actionCreator.updateIssue.calledOnce);
        done();
      });
    });

    test('sendEmail toggles email sending for description changes', function() {
      window.actionCreator = {
        updateIssue: sinon.stub(),
      };

      element.token = 'abcd';
      element.issueId = 10;
      element.projectName = 'chromium';

      const editor = element.shadowRoot.querySelector('#editDescription');

      editor.sendEmail = false;
      editor.save();

      assert.deepEqual(actionCreator.updateIssue.args[0][1], {
        trace: {token: 'abcd'},
        issueRef: {
          projectName: 'chromium',
          localId: 10,
        },
        commentContent: '',
        isDescription: true,
        sendEmail: false,
      });
      assert.isTrue(actionCreator.updateIssue.calledOnce);

      editor.sendEmail = true;
      editor.save();

      assert.deepEqual(actionCreator.updateIssue.args[1][1], {
        trace: {token: 'abcd'},
        issueRef: {
          projectName: 'chromium',
          localId: 10,
        },
        commentContent: '',
        isDescription: true,
        sendEmail: true,
      });
      assert.isTrue(actionCreator.updateIssue.calledTwice);
    });
  });
})();
</script>
