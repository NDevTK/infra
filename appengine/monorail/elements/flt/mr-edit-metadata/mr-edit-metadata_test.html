<meta charset="utf-8">
<script src="/bower_components/webcomponentsjs/webcomponents-loader.js"></script>
<script src="/bower_components/web-component-tester/browser.js"></script>
<link rel="import" href="/elements/flt/mr-edit-metadata/mr-edit-metadata.html">
<test-fixture id="basic">
  <template>
    <mr-edit-metadata></mr-edit-metadata>
  </template>
</test-fixture>
<script>
(function() {
  'use strict';

  suite('basic tests', function() {
    var element;

    setup(function() {
      element = fixture('basic');
    });

    test('delta empty when no changes', function() {
      assert.deepEqual(element.getDelta(), {});
    });

    test('toggling checkbox toggles sendEmail', function(done) {
      element.sendEmail = false;

      flush(() => {
        const checkbox = element.shadowRoot.querySelector('#sendEmail');

        checkbox.click();
        assert.equal(checkbox.checked, true);
        assert.equal(element.sendEmail, true);

        checkbox.click();
        assert.equal(checkbox.checked, false);
        assert.equal(element.sendEmail, false);

        checkbox.click();
        assert.equal(checkbox.checked, true);
        assert.equal(element.sendEmail, true);
        done();
      });
    });

    test('changing status produces delta change', function(done) {
      element.statuses = [
        {'status': 'New'},
        {'status': 'Old'},
        {'status': 'Test'},
      ];
      element.status = 'New';
      flush(() => {
        Polymer.dom(element.root).querySelector('#statusInput').value = 'Old';
        assert.deepEqual(element.getDelta(), {
          status: 'Old',
        });
        done();
      });
    });

    test('changing summary produces delta change', function(done) {
      element.summary = 'Old summary';
      flush(() => {
        Polymer.dom(element.root).querySelector(
          '#summaryInput').value = 'newfangled fancy summary';
        assert.deepEqual(element.getDelta(), {
          summary: 'newfangled fancy summary',
        });
        done();
      });
    });

    test('changing custom fields produces delta', function(done) {
      element.fieldDefs = [
        {
          fieldRef: {
            fieldName: 'testField',
            fieldId: 1,
          },
        },
        {
          fieldRef: {
            fieldName: 'fakeField',
            fieldId: 2,
          },
        },
      ];
      flush(() => {
        Polymer.dom(element.root).querySelector(
          '#testFieldInput').setValue('test value');
        assert.deepEqual(element.getDelta(), {
          fieldValuesAdded: [
            {
              fieldRef: {
                fieldName: 'testField',
                fieldId: 1,
              },
              value: 'test value',
            },
          ],
        });
        done();
      });
    });

    test('_optionsForField computes options for fieldDef', function() {
      const labels = [
        {
          label: 'enumField-one',
        },
        {
          label: 'enumField-two',
        },
      ];

      assert.deepEqual(element._optionsForField(labels, 'enumField'), [
        {
          label: 'enumField-one',
          optionName: 'one',
        },
        {
          label: 'enumField-two',
          optionName: 'two',
        },
      ]);
    });

    test('changing enum fields produces delta', function(done) {
      element.fieldDefs = [
        {
          fieldRef: {
            fieldName: 'enumField',
            fieldId: 1,
            type: 'ENUM_FIELD'
          },
          isMultivalued: true,
        },
      ];
      element.projectConfig = {
        labelDefs: [
          {
            label: 'enumField-one',
          },
          {
            label: 'enumField-two',
          },
        ]
      };
      flush(() => {
        Polymer.dom(element.root).querySelector(
          '#enumFieldInput').setValue(['one', 'two']);
        assert.deepEqual(element.getDelta(), {
          fieldValuesAdded: [
            {
              fieldRef: {
                fieldName: 'enumField',
                fieldId: 1,
              },
              value: 'one',
            },
            {
              fieldRef: {
                fieldName: 'enumField',
                fieldId: 1,
              },
              value: 'two',
            },
          ],
        });
        done();
      });
    });

    test('approver input appears when user has privileges', function(done) {
      assert.isNull(
        element.shadowRoot.querySelector('#approversInput'));
      element.isApproval = true;
      element.hasApproverPrivileges = true;

      flush(() => {
        assert.isNotNull(
          element.shadowRoot.querySelector('#approversInput'));
        done();
      });
    });
  });
})();
</script>
