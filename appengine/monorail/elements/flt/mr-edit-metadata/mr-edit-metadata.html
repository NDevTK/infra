<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/chopsui/chops-button.html">
<link rel="import" href="../../../bower_components/vaadin-upload/vaadin-upload.html">
<link rel="import" href="../../../bower_components/vaadin-upload/theme/lumo/vaadin-upload.html">

<link rel="import" href="../../chops/chops-checkbox/chops-checkbox.html">
<link rel="import" href="../../mr-error/mr-error.html">
<link rel="import" href="../shared/mr-flt-styles.html">
<link rel="import" href="../shared/metadata-mixin.html">
<link rel="import" href="./mr-edit-field.html">

<dom-module id="mr-edit-metadata">
  <template>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons"
          rel="stylesheet">
    <style include="mr-flt-styles">
      :host {
        display: block;
        font-size: 12px;
        --mr-edit-field-styles: {
          box-sizing: border-box;
          width: 95%;
          padding: 0.25em 4px;
        }
      }
      vaadin-upload {
        margin-bottom: 1em;
      }
      select,
      input {
        @apply --mr-edit-field-styles;
      }
      label {
        font-weight: bold;
        word-wrap: break-word;
        text-align: right;
      }
      label.checkbox {
        text-align: left;
      }
      textarea {
        width: 100%;
        margin: 0.5em 0;
        box-sizing: border-box;
        border: 1px solid hsl(0, 0%, 70%);
        height: 8em;
        transition: height 0.1s ease-in-out;
        padding: 0.5em 4px;
        grid-column-start: 1;
        grid-column-end: 2;
      }
      button.toggle {
        background: none;
        color: hsl(240, 100%, 40%);
        border: 0;
        width: 100%;
        padding: 0.25em 0;
        text-align: left;
      }
      button.toggle:hover {
        cursor: pointer;
        text-decoration: underline;
      }
      .discard-button {
        margin-right: 16px;
      }
      .edit-actions {
        width: 100%;
        margin: 0.5em 0;
        text-align: right;
      }
      .input-grid {
        padding: 0.5em 0;
        display: grid;
        max-width: 100%;
        grid-gap: 10px;
        grid-template-columns: 120px auto;
        align-items: flex-start;
      }
      .group {
        width: 100%;
        border: 1px solid hsl(0, 0%, 83%);
        grid-column: 1 / -1;
        margin: 0;
        margin-bottom: 0.5em;
        padding: 0;
        padding-bottom: 0.5em;
      }
      .group legend {
        margin-left: 130px;
      }
      .group-title {
        text-align: center;
        font-style: oblique;
        margin-top: 4px;
        margin-bottom: -8px;
      }
      @media (max-width: 600px) {
        label {
          margin-top: 8px;
          text-align: left;
        }
        .input-grid {
          grid-gap: 4px;
          grid-template-columns: 100%;
        }
      }
    </style>
    <template is="dom-if" if="[[error]]">
      <mr-error>[[error]]</mr-error>
    </template>
    <form id="editForm">
      <textarea id="commentText" placeholder="Add a comment"></textarea>
      <vaadin-upload files="{{_newAttachments}}" no-auto hidden$="[[disableAttachments]]">
        <i class="material-icons" slot="drop-label-icon">cloud_upload</i>
      </vaadin-upload>
      <div class="input-grid">
        <template is="dom-if" if="[[!isApproval]]">
          <label for="summaryInput">Summary:</label>
          <input id="summaryInput" value$="[[summary]]" />
        </template>
        <template is="dom-if" if="[[statuses.length]]">
          <label for="statusInput">Status:</label>

          <select id="statusInput">
            <template is="dom-repeat" items="[[_statusesGrouped]]" as="group">
              <optgroup label$="[[group.name]]" hidden$="[[!group.name]]">
                <template is="dom-repeat" items="[[group.statuses]]">
                  <option
                    value$="[[item.status]]"
                    selected$="[[_computeIsSelected(status, item.status)]]"
                  >
                    [[item.status]]
                    <template is="dom-if" if="[[item.docstring]]">
                      = [[item.docstring]]
                    </template>
                  </option>
                </template>
              </optgroup>

              <template is="dom-if" if="[[!group.name]]">
                <template is="dom-repeat" items="[[group.statuses]]">
                  <option
                    value$="[[item.status]]"
                    selected$="[[_computeIsSelected(status, item.status)]]"
                  >
                    [[item.status]]
                    <template is="dom-if" if="[[item.docstring]]">
                      = [[item.docstring]]
                    </template>
                  </option>
                </template>
              </template>
            </template>
          </select>
        </template>


        <template is="dom-if" if="[[!isApproval]]">
          <label for="ownerInput" on-click="_clickLabelForCustomInput">Owner:</label>
          <mr-edit-field
            id="ownerInput"
            type="USER_TYPE"
            ac-type="owner"
            initial-values="[[_wrapList(ownerName)]]"
          ></mr-edit-field>

          <label for="ccInput" on-click="_clickLabelForCustomInput">CC:</label>
          <mr-edit-field
            id="ccInput"
            type="USER_TYPE"
            initial-values="[[_mapUserRefsToNames(cc)]]"
            multi
          ></mr-edit-field>

          <label for="componentsInput" on-click="_clickLabelForCustomInput">Components:</label>
          <mr-edit-field
            id="componentsInput"
            type="STR_TYPE"
            initial-values="[[_mapComponentRefsToNames(components)]]"
            ac-type="component"
            multi
          ></mr-edit-field>
        </template>

        <template is="dom-if" if="[[_and(hasApproverPrivileges, isApproval)]]">
          <label for="approversInput" on-click="_clickLabelForCustomInput">Approvers:</label>
          <mr-edit-field
            id="approversInput"
            type="USER_TYPE"
            initial-values="[[_mapUserRefsToNames(approvers)]]"
            multi
          ></mr-edit-field>
        </template>

        <template is="dom-repeat" items="[[_fieldDefsWithGroups]]" as="group">
          <fieldset class="group">
            <legend>[[group.groupName]]</legend>
            <div class="input-grid">
              <template is="dom-repeat" items="[[group.fieldDefs]]" as="field">
                <label
                  hidden$="[[_fieldIsHidden(showNicheFields, field.isNiche)]]"
                  for$="[[_idForField(field.fieldRef.fieldName)]]"
                  on-click="_clickLabelForCustomInput"
                  title$="[[field.docstring]]"
                >
                  [[field.fieldRef.fieldName]]:
                </label>
                <mr-edit-field
                  hidden$="[[_fieldIsHidden(showNicheFields, field.isNiche)]]"
                  id$="[[_idForField(field.fieldRef.fieldName)]]"
                  name="[[field.fieldRef.fieldName]]"
                  type="[[field.fieldRef.type]]"
                  options="[[_optionsForField(projectConfig.labelDefs, field.fieldRef.fieldName)]]"
                  initial-values="[[_valuesForField(_fieldValueMap, field.fieldRef.fieldName, phaseName)]]"
                  multi="[[field.isMultivalued]]"
                ></mr-edit-field>
              </template>
            </div>
          </fieldset>
        </template>

        <template is="dom-repeat" items="[[_fieldDefsWithoutGroup]]" as="field">
          <label
            hidden$="[[_fieldIsHidden(showNicheFields, field.isNiche)]]"
            for$="[[_idForField(field.fieldRef.fieldName)]]"
            on-click="_clickLabelForCustomInput"
            title$="[[field.docstring]]"
          >
            [[field.fieldRef.fieldName]]:
          </label>
          <mr-edit-field
            hidden$="[[_fieldIsHidden(showNicheFields, field.isNiche)]]"
            id$="[[_idForField(field.fieldRef.fieldName)]]"
            name="[[field.fieldRef.fieldName]]"
            type="[[field.fieldRef.type]]"
            options="[[_optionsForField(projectConfig.labelDefs, field.fieldRef.fieldName)]]"
            initial-values="[[_valuesForField(_fieldValueMap, field.fieldRef.fieldName, phaseName)]]"
            multi="[[field.isMultivalued]]"
          ></mr-edit-field>
        </template>

        <template is="dom-if" if="[[!isApproval]]">
          <label for="blockedOnInput" on-click="_clickLabelForCustomInput">Blocked on:</label>
          <mr-edit-field
            id="blockedOnInput"
            initial-values="[[_mapBlockerRefsToIdStrings(blockedOn, projectName)]]"
            multi
          ></mr-edit-field>

          <label for="blockingInput" on-click="_clickLabelForCustomInput">Blocking:</label>
          <mr-edit-field
            id="blockingInput"
            initial-values="[[_mapBlockerRefsToIdStrings(blocking, projectName)]]"
            multi
          ></mr-edit-field>

          <label for="labelsInput" on-click="_clickLabelForCustomInput">Labels:</label>
          <mr-edit-field
            id="labelsInput"
            ac-type="label"
            initial-values="[[labelNames]]"
            multi
          ></mr-edit-field>
        </template>

        <span hidden$="[[!_nicheFieldCount]]"></span>
        <button type="button" class="toggle" on-click="toggleNicheFields" hidden$="[[!_nicheFieldCount]]">
          <span hidden$="[[showNicheFields]]">
            Show all fields ([[_nicheFieldCount]] currently hidden)
          </span>
          <span hidden$="[[!showNicheFields]]">
            Hide niche fields ([[_nicheFieldCount]] currently shown)
          </span>
        </button>

        <span></span>
        <chops-checkbox
          id="sendEmail"
          on-checked-change="_sendEmailChecked"
          checked="[[sendEmail]]"
        >Send email</chops-checkbox>
      </div>
      <div class="edit-actions">
        <chops-button
          on-click="discard"
          class="de-emphasized discard-button"
          disabled="[[disabled]]"
        >
          <i class="material-icons">close</i>
          Discard changes
        </chops-button>
        <chops-button on-click="save" class="emphasized" disabled="[[disabled]]">
          <i class="material-icons">create</i>
          Save changes
        </chops-button>
      </div>
    </form>
  </template>
  <script src="./mr-edit-metadata.js"></script>
<dom-module>
<dom-module id="upload-theme" theme-for="vaadin-upload-file">
  <!-- Custom styling to hide some unused controls and add some
       extra affordances. -->
  <template>
    <style>
      [part="start-button"], [part="status"], [part="progress"] {
        display:none;
      }
      [part="row"]:hover {
        background: #eee;
      }
      [part="clear-button"] {
        cursor: pointer;
        font-size: 100%;
      }
      [part="clear-button"]:before {
        font-family: sans-serif;
        content: 'X';
      }
    </style>
  </template>
</dom-module>
