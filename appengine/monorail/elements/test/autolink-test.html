<!DOCTYPE html>
<title>Autolink Test</title>
<meta charset="utf-8">
<script src="/bower_components/webcomponentsjs/webcomponents-lite.js"></script>
<script src="/bower_components/web-component-tester/browser.js"></script>

<script src="/static/js/autolink.js"></script>
<script>
  'use strict';
  const components = window.__autolink.Components;
  const createIssueRefRun = window.__autolink.createIssueRefRun;
  suite('crbug component functions', function() {
      const {lookup, extractRefs, replacers} = components.get('01-tracker-crbug');

      test('Extract crbug project and local ids', function() {
          let match = new RegExp(replacers[0].re, 'g').exec('https://crbug.com/monorail/1234');
          let ref = extractRefs(match);
          assert.deepEqual(ref, {projectName: 'monorail', localId: '1234'});
      });

      test('Replace crbug with found components', function() {
          const {re, replacerFunc} = replacers[0];
          const str = 'crbug.com/monorail/1234';
          const match = new RegExp(re, 'g').exec(str);
          const components = {closedRefs: [{localId: 1234, projectName: 'monorail'}, {}]};
          const actualRun = replacerFunc(match, components);
          assert.deepEqual(
              actualRun,
              {
                  tag: 'a',
                  css: 'strikeThrough',
                  href:'/p/monorail/issues/detail?id=1234',
                  content: str
              }
          );
      });

      test('Replace crbug with default project_name', function() {
          const {re, replacerFunc} = replacers[0];
          const str = 'crbug.com/1234';
          const match = new RegExp(re, 'g').exec(str);
          const components = {openRefs: [{localId: 134}, {localId: 1234, projectName: 'chromium'}]};
          const actualRun = replacerFunc(match, components);
          assert.deepEqual(
              actualRun,
              {
                  tag: 'a',
                  href:'/p/chromium/issues/detail?id=1234',
                  css:'',
                  content: str
              }
          );
      });

      test('Replace crbug with no found components', function() {
          const {re, replacerFunc} = replacers[0];
          const str = 'crbug.com/1234';
          const match = new RegExp(re, 'g').exec(str);
          const components = {};
          const actualRun = replacerFunc(match, components);
          assert.deepEqual(actualRun, {content: str});
      });
  });

  suite('regular tracker component functions', function() {
      const {lookup, extractRefs, replacers} = components.get('02-tracker-regular');
      const str = 'bugs=123, monorail:234 or #345 and proj:#456';
      const {re, replacerFunc} = replacers[0];
      const match = new RegExp(re, 'g').exec(str);

      test('Extract tracker projects and local ids', function() {
          const actualRefs = extractRefs(match);
          assert.deepEqual(
              actualRefs,
              [{projectName: 'chromium', localId: '123'},
               {projectName: 'monorail', localId: '234'},
               {projectName: 'monorail', localId: '345'},
               {projectName: 'proj', localId: '456'}]);
      });

      test('Replace tracker refs.', function() {
          const components = {
              openRefs: [
                  {projectName: 'monorail', localId: 888},
                  {projectName: 'chromium', localId: '123'},
              ],
              closedRefs: [
                  {projectName: 'proj', localId: 456},
              ]
          };
          const actualTextRuns = replacerFunc(match, components);
          assert.deepEqual(actualTextRuns,
                           [
                               {
                                   tag: 'a',
                                   href:'/p/chromium/issues/detail?id=123',
                                   css: '',
                                   content: '123',
                               },
                               {
                                   content: 'monorail:234',
                               },
                               {
                                   content: '#345',
                               },
                               {
                                   tag: 'a',
                                   href:'/p/proj/issues/detail?id=456',
                                   css: 'strikeThrough',
                                   content: 'proj:#456',
                               },
                           ]
                          );
      });
  });
</script>
