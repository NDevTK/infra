# VM Leaser Service

This document is intended to be a reference for any developers looking to modify or use the VM Leaser Service. It provides the necessary details for development and deployment. Please contact justinsuen@google.com for any questions with regards to the VM Leaser Service implementation.

[TOC]

## Prerequisites

To develop and use the VM Leaser Service, you must have the following installed:
* [Docker](https://g3doc.corp.google.com/cloud/containers/g3doc/glinux-docker/install.md?cl=head) - Note that this is not supported by the gLinux team out of the box.
* [gcloud CLI](https://g3doc.corp.google.com/cloud/sdk/g3doc/index.md?cl=head#installing-and-using-the-cloud-sdk) - This SDK is very helpful and needed for service deployments.
* [grpcurl](https://github.com/fullstorydev/grpcurl) (optional) - This is very useful for making calls to gRPC services.

## Development

There are several workflows for local development. Since we deploy this service via Cloud Run, we use Docker to maintain development images and service containers.

### Run Service Locally

The command to run the service locally is

```bash
> make dev
```

This command builds a local version of the image and tags it as `gcr.io/${GCP_PROJECT}/vm-leaser-service:latest`. Then it runs a Docker container to expose the service at `localhost:50051`. The container is removed once the command ends.

### Interact with the Local Service

To interact with the service, you can use `grpcurl`. Locally, there is no authentication and requests are run without TLS. Cloud Run takes care of it out of the box though so fret not. The `-plaintext` flag is specified for this reason.

To list all services available at the endpoint:
```bash
> grpcurl -plaintext \
  -H "Authorization: Bearer $(gcloud auth print-identity-token)" \
  localhost:50051 \
  list

grpc.reflection.v1alpha.ServerReflection
vm_leaser.api.v1.VMLeaserService
```

To list all APIs available for a given service:
```bash
> grpcurl -plaintext \
  -H "Authorization: Bearer $(gcloud auth print-identity-token)" \
  localhost:50051 \
  list vm_leaser.api.v1.VMLeaserService

vm_leaser.api.v1.VMLeaserService.ExtendLease
vm_leaser.api.v1.VMLeaserService.LeaseVM
vm_leaser.api.v1.VMLeaserService.ReleaseVM
```

To call an RPC, you can specify the proto and payload via `grpcurl`. Here is an example of how to lease a VM:
```bash
> grpcurl -plaintext \
  -H "Authorization: Bearer $(gcloud auth print-identity-token)" \
  -proto api/v1/vm_leaser.proto \
  -d '{
    "host_reqs": {
      "gce_image": "projects/chrome-fleet-vm-leaser-dev/global/images/betty-arc-r-release",
      "gce_region": "us-central1-a",
      "gce_project": "chrome-fleet-vm-leaser-dev",
      "gce_network": "global/networks/default",
      "gce_machine_type": "e2-medium",
      "gce_disk_size": "20"
    }
  }' \
  localhost:50051 \
  vm_leaser.api.v1.VMLeaserService.LeaseVM

{
  "leaseId": "vm-12107b1b-52be-475f-bdd5-8b68306645d2",
  "vm": {
    "id": "vm-12107b1b-52be-475f-bdd5-8b68306645d2",
    "address": {
      "host": "10.128.0.44",
      "port": 22
    }
  }
}
```

An example to release a VM:
```bash
> grpcurl -plaintext \
  -H "Authorization: Bearer $(gcloud auth print-identity-token)" \
  -proto api/v1/vm_leaser.proto \
  -d '{
    "lease_id": "vm-bcb29756-ff94-4da9-a531-2cd20bad9771",
    "gce_project": "chrome-fleet-vm-leaser-dev",
    "gce_region": "us-central1-a"
  }' \
  localhost:50051 \
  vm_leaser.api.v1.VMLeaserService.ReleaseVM

{
  "leaseId": "vm-bcb29756-ff94-4da9-a531-2cd20bad9771"
}
```

Please consult the `grpcurl` [documentation](https://github.com/fullstorydev/grpcurl) for more information.

## Production

For the production environment, we rely on [LUCI K8s](https://source.corp.google.com/chops_infra_internal/data/k8s/projects/vm-leaser/) to automatically deploy to GKE.

### Interact with the Production Service

To interact with the service, you can use `grpcurl`. Cloud Run provides TLS out of the box so the default port is `443`. We will also need to authenticate. For these examples, we will use a Bearer token generated by `gcloud auth print-identity-token`. You can also generate a token using `luci-auth token`.

To list the RPCs available for our service:
```bash
> grpcurl \
  -H "Authorization: Bearer $(gcloud auth print-identity-token)" \
  staging.vmleaser.api.cr.dev:443 \
  list vm_leaser.api.v1.VMLeaserService

vm_leaser.api.v1.VMLeaserService.ExtendLease
vm_leaser.api.v1.VMLeaserService.LeaseVM
vm_leaser.api.v1.VMLeaserService.ReleaseVM
```

To call an RPC, you can specify the proto and payload via `grpcurl`. Here is an example of how to lease a VM:
```bash
> grpcurl \
  -H "Authorization: Bearer $(gcloud auth print-identity-token)" \
  -proto api/v1/vm_leaser.proto \
    -d '{
    "host_reqs": {
      "gce_image": "projects/chrome-fleet-vm-leaser-dev/global/images/betty-arc-r-release",
      "gce_region": "us-central1-a",
      "gce_project": "chrome-fleet-vm-leaser-dev",
      "gce_network": "global/networks/default",
      "gce_machine_type": "e2-medium",
      "gce_disk_size": "20"
    }
  }' \
  staging.vmleaser.api.cr.dev:443 \
  vm_leaser.api.v1.VMLeaserService.LeaseVM

{
  "leaseId": "vm-12107b1b-52be-475f-bdd5-8b68306645d2",
  "vm": {
    "id": "vm-12107b1b-52be-475f-bdd5-8b68306645d2",
    "address": {
      "host": "10.128.0.44",
      "port": 22
    }
  }
}
```
