# VM Leaser Service

This document is intended to be a reference for any developers looking to modify or use the VM Leaser Service. It provides the necessary details for development and deployment. Please contact justinsuen@google.com for any questions with regards to the VM Leaser Service implementation.

[TOC]

## Prerequisites

To develop and use the VM Leaser Service, you must have the following installed:
* [Docker](https://g3doc.corp.google.com/cloud/containers/g3doc/glinux-docker/install.md?cl=head) - Note that this is not supported by the gLinux team out of the box.
* [gcloud CLI](https://g3doc.corp.google.com/cloud/sdk/g3doc/index.md?cl=head#installing-and-using-the-cloud-sdk) - This SDK is very helpful and needed for service deployments.
* [grpcurl](https://github.com/fullstorydev/grpcurl) (optional) - This is very useful for making calls to gRPC services.

## Development

There are several workflows for local development. Since we deploy this service via Cloud Run, we use Docker to maintain development images and service containers.

### Run Service Locally

The command to run the service locally is

```bash
> make dev
```

This command builds a local version of the image and tags it as `gcr.io/${GCP_PROJECT}/vm-leaser-service:latest`. Then it runs a Docker container to expose the service at `localhost:50051`. The container is removed once the command ends.

### Interact with the Local Service

To interact with the service, you can use `grpcurl`. Locally, there is no authentication and requests are run without TLS. Cloud Run takes care of it out of the box though so fret not. The `-plaintext` flag is specified for this reason.

To list all services available at the endpoint:
```bash
> grpcurl -plaintext localhost:50051 list
grpc.reflection.v1alpha.ServerReflection
vm_leaser.api.VmLeaserService
```

To list all APIs available for a given service:
```bash
> grpcurl -plaintext localhost:50051 list vm_leaser.api.VmLeaserService
vm_leaser.api.VmLeaserService.ExtendLease
vm_leaser.api.VmLeaserService.LeaseVm
vm_leaser.api.VmLeaserService.ReleaseVm
```

To call an RPC, you can specify the proto and payload via `grpcurl`. Here is an example of how to lease a VM:
```bash
> grpcurl \
  -plaintext \
  -proto api/service.proto \
  -d '{}' \
  localhost:50051 \
  vm_leaser.api.VmLeaserService.LeaseVm

{
  "leaseId": "Test ID"
}
```

Please consult the `grpcurl` [documentation](https://github.com/fullstorydev/grpcurl) for more information.

## Production

For the production environment, we rely on gcloud commands to deploy and run our service on Cloud Run.

### Deploy Service to Prod

To build and deploy the service, you can run

```bash
> make deploy
```

This command builds the image, tags it as `gcr.io/${GCP_PROJECT}/vm-leaser-service:latest`, and deploys to Cloud Run. Once deployed, the command line will return the endpoint of the service.

### Interact with the Production Service

To interact with the service, you can use `grpcurl`. Cloud Run provides TLS out of the box so the default port is `443`. We will also need to authenticate. For these examples, we will use a Bearer token generated by `gcloud auth print-identity-token`.

To list the RPCs available for our service:
```bash
> grpcurl \
  -reflect-header "Authorization: Bearer $(gcloud auth print-identity-token)" \
  ${VM_LEASER_ENDPOINT}:443 \
  list vm_leaser.api.VmLeaserService

vm_leaser.api.VmLeaserService.ExtendLease
vm_leaser.api.VmLeaserService.LeaseVm
vm_leaser.api.VmLeaserService.ReleaseVm
```

To call an RPC, you can specify the proto and payload via `grpcurl`. Here is an example of how to lease a VM:
```bash
> grpcurl \
  -rpc-header "Authorization: Bearer $(gcloud auth print-identity-token)" \
  -proto api/service.proto \
  ${VM_LEASER_ENDPOINT}:443 \
  vm_leaser.api.VmLeaserService.LeaseVm

{
  "leaseId": "Test ID"
}
```

### Get Service Endpoint

The following script gets and sets the service endpoint:
```bash
VM_LEASER_ENDPOINT=$(\
  gcloud run services list \
  --project=chrome-fleet-vm-leaser-cr-exp \
  --region=us-west1 \
  --platform=managed \
  --format="value(status.address.url)")
export VM_LEASER_ENDPOINT=${VM_LEASER_ENDPOINT#https://}
echo ${VM_LEASER_ENDPOINT}
```
