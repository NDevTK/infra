<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../bower_components/iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-page-url/iron-page-url.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../elements/som-rev-range.html">
<link rel="import" href="../elements/som-linkify-behavior.html">

<dom-module id="som-extension-build-failure">
  <template>
    <style>
     .builder {
        border-radius: 2px;
        border: 1px solid #dcdcdc;
        font-size: smaller;
        margin: .1em;
        padding: .3em 0.5em;
        display: inline-block;
        background: #E75D54;
        color: #f4f4f4;
     }
     .infra-failure {
       background: #e0b0ff;
       color: #fff;
     }
     .suspect-cl-results {
       color: #FF8C00;
     }
     .builder a {
        font-weight: bold;
        text-decoration: none;
        color: #fff;
     }
     .header {
       color: #000;
     }
     .section {
       padding-bottom: 1em;
     }
     div.section:last-of-type {
       padding-bottom: 0;
     }
     .infra-failure a {
       color: #fff;
     }
     .build-failures {
       width: 100%;
       max-height: 200px;
       overflow-y: auto;
       padding-right: 20px;
     }
     .builder a:hover {
       text-decoration: underline;
     }
     #builders,
     #findit-results,
     #reasons,
     #regression-ranges {
       margin: .25em auto;
     }
    </style>
    <div>
      <div id="builders" class="section layout horizontal center">
        <template is="dom-if" if="[[_haveBuilders(extension)]]">
          <div class="header">
            Builders this step failed on:
          </div>
          <div>
            <template is="dom-repeat" items="[[extension.builders]]" as="builder">
              <span class$="[[_classForBuilder(builder)]]">
                <a target="_blank" href$="[[_linkify(linkStyle, builder.url)]]" title$="Failing for the last [[_failureCount(builder)]] build(s): [[builder.first_failure]] - [[builder.latest_failure]].">
                    [[builder.name]]
                    [[_failureCount(builder)]]
                </a>
              </span>
            </template>
          </div>
        </template>
      </div>
      <div class="section">
        <template is="dom-if" if="[[!_haveTests(extension.reason.tests)]]">
          No test result data available.
        </template>
        <template is="dom-if" if="[[_haveTests(extension.reason.tests)]]">
          <div class="header">
            [[_testText(extension.reason.tests)]]:
          </div>
          <div id="reasons">
            <div class="build-failures">
              <ul>
                <template is="dom-repeat" items="[[extension.reason.tests]]" as="test" sort="_sortTests">
                  <li id="test_results">
                    <a target="_blank" href$=[[_linkForTest(extension.reason,test.test_name)]]>
                      [[test.test_name]]
                    </a>
                    (
                    <a target="_blank" href$=[[_linkToCSForTest(test.test_name)]]>
                      Code Search
                    </a>
                    )
                    <template is="dom-if" if="[[_hasSuspect(test)]]">
                      <template is="dom-repeat" items="[[test.suspected_cls]]" as="testCL">
                        <img src="/images/findit.png" alt="findit" title="findit" height="20" width="20">
                        <span class="suspect-cl-results">
                           Findit (<a target="_blank" href="http://go/findit-manual">?</a>)
                           [[_finditApproach(testCL)]]
                          <a href$="https://chromium.googlesource.com/chromium/src/+/[[testCL.revision]]" target="_blank">
                              [[_textForCL(testCL.revision)]]
                          </a>
                        </span>
                      </template>
                    </template>
                    <template is="dom-if" if="[[_isFlaky(test)]]">
                      <img src="/images/findit.png" alt="findit" title="findit" height="20" width="20">
                      <span class="suspect-cl-results">
                        Findit
                        (<a target="_blank" href="http://go/findit-manual">?</a>)
                        results: Flaky
                      </span>
                    </template>
                  </li>
                </template>
              </ul>
            </div>
          </div>
        </template>
      </div>
      <div id="regression-ranges" class="section">
        <template is="dom-if" if="[[!_haveRegressionRanges(extension.regression_ranges)]]">
          No regression range information available.
        </template>
        <template is="dom-if" if="[[_haveRegressionRanges(extension.regression_ranges)]]">
          <div class="header">
            Regression ranges:
          </div>
          <template is="dom-repeat" items="[[extension.regression_ranges]]" as="regressionRange" filter="_showRegressionRange">
            <div>
              <som-rev-range range="[[regressionRange]]"></som-rev-range>
            </div>
          </template>
        </template>
      </div>
      <template is="dom-if" if="[[_haveFinditData(extension)]]">
        <div id="findit-results" class="section">
          <template is="dom-if" if="[[_finditIsRunning(extension)]]">
            <img src="/images/findit.png" alt="findit" title="findit" height="20" width="20">
            <strong class="suspect-cl-results">
              Findit is Analyzing...
            </strong>
            <br>
          </template>
          <template is="dom-if" if="[[_haveSuspectCLs(extension)]]">
            <template is="dom-repeat" items="[[_suspectedCls]]" as="cl">
              <img src="/images/findit.png" alt="findit" title="findit" height="20" width="20">
              <strong class="suspect-cl-results">
                Findit
                (<a target="_blank" href="http://go/findit-manual">?</a>)
                [[_finditApproach(cl)]]
                <a target="_blank" href$=[[_linkForCL(cl.revision)]] class="suspect-cl-link">
                  [[_textForCL(cl.revision)]]
                </a>
                with [[_finditConfidence(cl)]]% confidence.
              </strong>
              <a target="_blank" href$=[[extension.findit_url]]>
                More details...
              </a>
              <br>
            </template>
          </template>
        </div>
      </template>
    </div>
  </template>
  <script>
  (function() {
    'use strict';

    const codeSearchURL = 'https://cs.chromium.org/';
    const testResultsURL = 'https://test-results.appspot.com/';

    Polymer({
      is: 'som-extension-build-failure',
      behaviors: [LinkifyBehavior],

      properties: {
        extension: {
          type: Object,
          value: null
        },
        type: {
          type: String,
          value: ''
        },
        _suspectedCls: {
          type: Array,
          computed: '_computeSuspectedCls(extension)',
        },
      },

      _haveBuilders: function(extension) {
        return extension && extension.builders && extension.builders.length > 0;
      },

      _failureCount: function(builder) {
        // The build number range is inclusive.
        let numBuilds = builder.latest_failure - builder.first_failure + 1;
        if (numBuilds > 1) {
          return `[${numBuilds} since first detection]`;
        }
      },

      _classForBuilder: function(builder) {
        let classes = ['builder']
        if (this._failureCount(builder) > 1) {
          classes.push('multiple-failures');
        }
        if (this.type == 'infra-failure') {
          classes.push('infra-failure');
        }
        return classes.join(' ');
      },

      // This is necessary because FindIt sometimes returns duplicate results
      _computeSuspectedCls: function(extension) {
        if (!this._haveSuspectCLs(extension)) {
          return [];
        }
        let revisions = {};
        for (var i in extension.suspected_cls) {
          revisions[extension.suspected_cls[i].revision] = extension.suspected_cls[i];
        }
        return Object.values(revisions);
      },

      _finditIsRunning: function(extension) {
        return extension && extension.findit_status == 'RUNNING' && !this._haveSuspectCLs(extension);
      },

      _finditApproach: function(cl) {
        if (cl.analysis_approach == 'HEURISTIC') {
          return ' suspects CL ';
        } else {
          return ' found culprit ';
        }
      },

      _finditConfidence: function(cl) {
        return cl.confidence.toString();
      },

      _haveFinditData: function(extension) {
        return this._haveSuspectCLs(extension) || this._haveRegressionRanges(extension);
      },

      _haveSuspectCLs: function(extension) {
        return extension && extension.suspected_cls;
      },

      _haveRegressionRanges: function(regression_ranges) {
        return regression_ranges && regression_ranges.length > 0;

      },

      _haveTests: function(tests) {
        return tests && tests.length > 0;
      },

      _isFlaky: function(test) {
        return test && test.is_flaky;
      },

      _linkForTest: function(reason, testName) {
        return testResultsURL + 'dashboards/' +
          'flakiness_dashboard.html#' +
          'tests=' + encodeURIComponent(testName) +
          '&testType=' + encodeURIComponent(reason.step);
      },

      _linkToCSForTest: function(testName) {
        let url =  codeSearchURL + 'search/?q=';
        let query = testName;
        if (testName.includes('#')) {
          // Guessing that it's a java test; the format expected is
          // test.package.TestClass#testMethod. For now, just split around the #
          let split = testName.split('#');

          if (split.length > 2) {
            console.error('invalid java test name', testName);
          } else {
            query = split[0] + ' function:' + split[1];
          }
        }
        return url + encodeURIComponent(query);
      },

      _linkForCL: function(cl) {
        return 'https://crrev.com/' + cl;
      },

      _showRegressionRange: function(range) {
        return range.positions && range.positions.length > 0 &&
            range.repo != 'v8';
      },

      _sortTests: function(a, b) {
        return a.test_name.localeCompare(b.test_name);
      },

      _testText: function(tests) {
        // NOTE: This really shouldn't happen; we should only be calling this function
        // when tests is actually defined. We are though, for some reason, and it looks
        // like it might be some weird dom-repeat/Polymer bug. So check that tests is
        // ok here anyways.
        if (tests == null) {
          return '';
        }

        let len = tests.length;

        if (len == 1) {
          return "1 test failed";
        }
        return len.toString() + " tests failed";
      },

      _textForCL: function(cl) {
        return cl.substring(0, 7);
      },

      _hasSuspect: function(test) {
        return test && test.suspected_cls;
      },
    });
  })();
  </script>
</dom-module>
