<!DOCTYPE html>
<meta charset="utf-8">
<base href="/">
<script src="bower_components/webcomponentsjs/webcomponents-loader.js"></script>
<script src="/bower_components/web-component-tester/browser.js"></script>
<style>
  body {
    font-family: sans-serif;
  }
</style>
<script>
  var testFiles = [];
  [
    'som-alert-category-test.html',
    'som-alert-item-test.html',
    'som-alert-view-test.html',
    'som-annotations-test.html',
    'som-app-test.html',
    'som-bug-queue-test.html',
    'som-drawer-test.html',
    'som-examine-test.html',
    'som-extension-build-failure-test.html',
    'som-extension-cros-failure-test.html',
    'som-marked-element-test.html',
    'som-master-restarts-test.html',
    'som-rev-range-test.html',
    'som-swarming-bots-test.html',
    'som-test-expectation-form-test.html',
    'som-test-expectations-test.html',
    'som-test-results/som-builder-results-test.html',
    'som-test-results/som-master-results-test.html',
    'som-test-results/som-test-details-test.html',
    'som-webkit-tests-test.html',
    'tree-status/som-tree-status-test.html',
    'tree-status/som-tree-status-view-test.html',
  ].forEach((file) => {
    testFiles.push(`/test/${file}`);
    testFiles.push(`/test/${file}?dom=shadow`);
   });

  // BEGIN WCT MONKEYPATCH
  //
  // The following two functions are sort of a hack to work around WCT's
  // current lack of event listening hooks for things like "test finished" and
  // "suite finished". They exist in order to report test results back to
  // the go app that spawned the chromedriver that runs these tests.
  // See https://github.com/Polymer/web-component-tester/issues/271 for
  // more context.
  // TODO(seanmccullough): Serve this code from wct.go instead of inlining.
  let end = function() {
    let passes = WCT._reporter.stats.passes;
    let failures = WCT._reporter.stats.failures;
    fetch('/done', {
        method: 'POST',
        body: JSON.stringify({
            'passes': passes,
            'failures': failures,
            // TODO(seanmccullough): Report timeouts, other exceptions?
        }),
    }).then(function(resp) {
      window.console.log('done response', resp);
    }).catch(function(exp) {
      window.console.log('done exception ', exp);
    });
  };

  let testEnd = function() {
    let file = WCT._reporter.currentRunner.name;
    let suite = WCT._reporter.currentRunner.currentRunner.suite.title;
    let test = WCT._reporter.currentRunner.currentRunner.test.title;
    let state = WCT._reporter.currentRunner.currentRunner.test.state;

    fetch('/result', {
        method: 'POST',
        body: JSON.stringify({
            'file': file,
            'suite': suite,
            'test': test,
            'state': state,
            // TODO(seanmccullough): Indicate if dom=shadow for this run.
        }),
    }).then(function(resp) {
      window.console.log('result response', resp);
    }).catch(function(exp) {
      window.console.log('result exception ', exp);
    });
  };

  // Only register these listeners when running via the golang runner.
  if (window.location.search.indexOf("wct=go") != -1) {
    document.addEventListener('DOMContentLoaded', function() {
      WCT._reporter.on('test end', testEnd);
      WCT._reporter.on('end', end);
    });
  }
  // END WCT MONKEYPATCH

  WCT.loadSuites(testFiles);
</script>
