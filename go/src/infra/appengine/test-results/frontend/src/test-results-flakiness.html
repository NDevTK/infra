<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/vaadin-combo-box/vaadin-combo-box.html">

<dom-module id="test-results-flakiness">
  <template>
    <style>
      .loading {
        text-align: center;
        margin: 20px 0;
      }
      .error {
        text-align: center;
        color: red;
        margin: 20px 0;
      }
      .grid-container {
        @apply(--layout-vertical);
        @apply(--layout-center-justified);
        margin: 15px 0;
      }
      .grid-header {
        @apply(--layout-horizontal);
        background-color: #757575;
        color: #fff;
        font-weight: 400;
        padding: 10px;
      }
      .grid-row {
        @apply(--layout-horizontal);
        @apply(--layout-center-justified);
        background-color: #fff;
        border-top: 1px solid #F5F5F5;
        padding: 10px;
        height: 19px;
        overflow: hidden;
      }
      .grid-row-link {
        color: inherit;
        font-weight: 300;
        text-decoration: none;
        cursor: pointer;
        border-bottom: none;
      }
      .grid-row:hover {
        background-color: #F5F5F5;
        font-weight: 400;
      }
      .test-name {
        @apply(--layout-flex);
        overflow: hidden;
      }
      .test-stats {
        @apply(--layout-horizontal);
        width: 150px;
      }
      #omnibox {
        --paper-input-container-disabled: {
          opacity: 0.7;
        }
      }
    </style>

    <!-- Omnibox selector for test group -->
    <div class="error" hidden$="[[!_errorGroups]]">[[_errorGroups.error]]</div>
    <iron-ajax
        id="groupsAjax"
        url="/test_flakiness_groups"
        handle-as="json"
        loading="{{_loadingGroups}}"
        last-response="{{_groups}}"
        last-error="{{_errorGroups}}"></iron-ajax>
    <vaadin-combo-box
        id="omnibox"
        allow-custom-value
        disabled="[[_loadingGroups]]"
        label="[[_omniboxLabel(_loadingGroups)]]">
    </vaadin-combo-box>

    <!-- List of flaky tests -->
    <div class="loading" hidden$="[[!_loadingData]]">Loading data... </div>
    <div class="error" hidden$="[[!_errorData]]">[[_errorData.error]]</div>
    <iron-ajax
        id="dataAjax"
        url="/test_flakiness"
        handle-as="json"
        loading="{{_loadingData}}"
        last-response="{{_data}}"
        last-error="{{_errorData}}"></iron-ajax>
    <div id="tests" hidden$="[[_isEmpty(_data)]]">
      <div class="grid-container">
        <div class="grid-header">
          <div class="test-name">Test Name</div>
          <div class="test-stats">Flakiness</div>
          <div class="test-stats">Total Runs</div>
        </div>
        <template is="dom-repeat" items="[[_data]]" as="test">
          <a class="grid-row-link" href="[[_getTestResultsUrl(test)]]">
            <div class="grid-row">
              <div class="test-name">[[test.test_name]]</div>
              <div class="test-stats">[[_showPercentage(test.flakiness)]]%</div>
              <div class="test-stats">[[test.runs]]</div>
            </div>
          </a>
        </template>
      </div>
    </div>
  </template>
  <script>
    (function() {
      'use strict';

      var GroupKind = {
        TEAM: 'team',
        DIR: 'dir',
        UNKNOWN_TEAM: 'unknown-team',
        UNKNOWN_DIR: 'unknown-dir',
        TEST_SUITE: 'test-suite',
        SEARCH: 'search',
      };

      Polymer({
        is: 'test-results-flakiness',

        properties: {
          _groups: {
            type: Array,
            value: function() { return []; },
            observer: '_updateSuggestions',
          },
          _loadingGroups: {
            type: Boolean,
            value: false,
          },
          _loadingData: {
            type: Boolean,
            value: false,
          },
          _data: {
            type: Array,
            value: function() { return []; },
          },
          _ignoreGroupChange: {
            type: Boolean,
            value: false,
          },
        },

        observers: [
          '_subrouteChanged(route.path)',
        ],

        listeners: {
          'omnibox.value-changed': '_selectGroup',
        },

        _omniboxLabel: function(loadingGroups) {
          if (loadingGroups) {
            return 'Loading...'
          }
          return 'Please enter search term e.g. team name, test suite name ' +
            ', dir name or any part of the test name';
        },

        _getTestResultsUrl: function(test) {
          // TODO(sergiyb): Investigate why for some tests, we get no recorded
          // runs, e.g. for "LoaderTest.Foo".
          return '/dashboards/flakiness_dashboard.html#testType=' +
              encodeURIComponent(test.normalized_step_name) + '&tests=' +
              encodeURIComponent(test.test_name);
        },

        _showPercentage: function(rate) {
          return (rate * 100).toFixed(2);
        },

        _isEmpty: function(obj) {
          if (typeof obj === 'undefined') {
            return true;
          } else if (typeof obj === 'object') {
            if (Array.isArray(obj)) {
              return obj.length === 0;
            } else {
              return (obj === null || Object.keys(obj).length === 0 &&
                      obj.constructor === Object);
            }
          } else {
            return !Boolean(obj);
          }
        },

        _labelForGroup: function(group) {
          switch (group.kind) {
            case GroupKind.TEAM:
              return 'Team "' + group.name + '"';
            case GroupKind.DIR:
              return 'Directory "' + group.name + '"';
            case GroupKind.UNKNOWN_TEAM:
              return 'Tests with unknown owner';
            case GroupKind.UNKNOWN_DIR:
              return 'Tests with unknown directory';
            case GroupKind.TEST_SUITE:
              return 'Test Suite "' + group.name + '"';
            default:
              console.error('Unexpected group kind:', group.kind);
          }
        },

        _updateSuggestions: function() {
          let suggestions = [];
          let selectedValue;
          for (let i = 0; i < this._groups.length; i++) {
            let group = this._groups[i];
            let label = this._labelForGroup(group);
            if (label) {
              // We use 1-based indicies since vaadin-combo-box treats value 0
              // as empty selection.
              suggestions.push({label: label, value: i+1});
            }

            if (this._group && group.name === this._group.name &&
                group.kind === this._group.kind) {
              selectedValue = i + 1;
            }
          }

          suggestions.sort(function(a, b) {
            if (a.label < b.label) {
              return -1;
            } else if (a.label > b.label) {
              return 1;
            } else {
              return 0;
            }
          });

          this.$.omnibox.items = suggestions;
          if (this._group) {
            if (this._group.kind === 'search') {
              this._updateSelectedGroup(this._group.name)
            } else {
              this._updateSelectedGroup(selectedValue);
            }
          }
        },

        _updateSelectedGroup: function(value) {
          if (value !== this.$.omnibox.value) {
            this._ignoreGroupChange = true;
            this.$.omnibox.value = value;
          }
        },

        _navigateTo: function(group) {
          let path = group ? '/' + group.kind + '/' + group.name : '';
          this.set('route.path', path);
        },

        _selectGroup: function(ev) {
          // TODO(sergiyb): When the user selects an element from the
          // autocompletion list (e.g. Test Suite "LoaderTest"), then places the
          // cursor into the input field, makes no changes and hits Enter, the
          // app treats this as a custom input and navigates to
          // /flakiness/search/Test%2520Suite%2520%2522LoaderTest%2522, which
          // returns no results. It's confusing and we should instead detect
          // this and search for selected item: /flakiness/test-suite/LoaderTest
          if (this._ignoreGroupChange) {
            this._ignoreGroupChange = false;
            return;
          }

          let value = ev.detail.value;
          if (!value) {
            return;
          }

          if (typeof value === 'number') {
            this._navigateTo(this._groups[value - 1]);
          } else if (typeof value === 'string') {
            this._navigateTo({kind: 'search', name: value});
          } else {
            console.error('Unexpected value type for selected group');
          }
        },

        _loadData: function() {
          if (!this._group) {
            console.error('Tried to load data without specifying the group');
            return;
          }

          this._data = '';
          this._error = '';
          this.$.dataAjax.params = {
            'groupKind': this._group.kind,
            'groupName': this._group.name,
          };
          this.$.dataAjax.generateRequest();
        },

        _parseGroupFromPath: function(newPath) {
          if (!newPath) {
            return;
          }

          let path = newPath.replace(/^\//, '');  // strip leading slash
          if (path === '') {
            return;
          }

          let slash = path.indexOf('/')
          if (slash === -1) {
            console.error('Missing slash (/) in the subpath.');
            this._navigateTo();
            return;
          }

          let kind = path.substr(0, slash);
          let name = path.substr(slash + 1);

          if (Object.values(GroupKind).indexOf(kind) === -1) {
            console.error('Unknown group kind in the subpath.');
            this._navigateTo();
            return;
          }

          if (!name) {
            console.error('Empty name in the subpath.');
            this._navigateTo();
            return;
          }

          return {
            kind: kind,
            name: name,
          };
        },

        _subrouteChanged: function(newPath) {
          this._group = this._parseGroupFromPath(newPath)
          if (this._group) {
            this._loadData();
          } else {
            this._data = [];
            this._updateSelectedGroup('');
          }

          if (!this.$.omnibox.items || this.$.omnibox.items.length === 0) {
            this.$.groupsAjax.generateRequest();
          }
        },
      });
    })();
  </script>
</dom-module>
