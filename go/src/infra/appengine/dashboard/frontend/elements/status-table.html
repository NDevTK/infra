<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="/elements/service-row.html">
<link rel="import" href="/elements/table-footer.html">

<dom-module id="status-table">
  <template>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      .card {
        background-color: white;
        box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
        color: rgba(0, 0, 0, 0.87);
        font: 1.2em "Roboto";
        padding: 24px;
      }
      .circle-container {
        padding-left: 10px;
      }
      .date-th {
        width: 11.43%;
      }
      .footer,
      th {
        height: 56px;
      }
      .header {
        height: 64px;
        line-height: 64px; // vertically center text
      }
      .marker {
        background-color: #e8eaed;
        width: 2px;
        height: 26px;
        top: 12px;
        position: absolute;
      }
      table {
        border-collapse: collapse;
        font-family: 'Roboto', 'Noto', sans-serif;
        padding: 24px;
        width: 100%;
      }
      td {
        font-size: .81em;
        position: relative;
      }
      th {
        color: rgba(0, 0, 0, 0.54);
        font: .76em "Roboto";
      }
      th:first-child {
        text-align: left;
      }
      tr {
        border: solid silver;
        border-width: 1px 0;
        height: 48px;
      }
      tr:first-child {
        border-top: none;
      }
      tr:last-child {
        border-bottom: none;
      }
    </style>
    <link rel="stylesheet" type="text/css" href="/static/icons.css">
    <div class="layout horizontal center-justified">
      <div class="card">
        <table>
          <tr>
            <th>Current Status</th>
            <template is="dom-repeat" items="[[formattedDates]]">
              <th class="date-th">[[item]]</th>
            </template>
          </tr>
          <template is="dom-repeat" items="[[services]]">
            <tr>
              <td>
                <template is="dom-repeat" items="[[_computeCurrentIncidents(item.incidents)]]">
                  <span class="circle-container">
                    <i class$="circle [[item]]"></i>
                    <template is="dom-if" if="{{_showToolTip(item)}}">
                      <paper-tooltip>Details coming soon!</paper-tooltip>
                    </template>
                  </span>
                </template>
                [[item.name]]
              </td>
              <td colspan="7">
                <template is="dom-repeat" items="[[_markerPositions]]" as="position">
                  <i class="marker" style="left: [[position]]%"></i>
                </template>
                <service-row incidents="[[_computePreviousIncidents(item.incidents)]]"
                  dates="[[dates]]"></service-row>
              </td>
            </tr>
          </template>
          <tr class="footer">
            <td colspan="8">
              <table-footer latest-date="{{latestDateTs}}"></table-footer>
            </dd>
          </tr>
        </table>
      </div>
    </div>
  </template>
  <script>
    'use strict';

    const MARKER_POSITIONS = [
      `0`, `${100/7}`, `${200/7}`, `${300/7}`, `${400/7}`, `${500/7}`, `${600/7}`
    ];

    class StatusTable extends Polymer.Element {
      static get is() { return 'status-table'; }

      ready() {
        super.ready();
      }

      static get properties() {
        return {
          services: {
            type: Array,
            value: () => { return []; },
          },
          latestDateTs: {
            type: Number,
            notify: true,
          },
          // All dates shown on the dashboard should be the same across all
          // elements on the page.
          formattedDates: {
            type: Array,
            value: [],
          },
          dates: {
            type: Array,
            value: [],
          },
          _markerPositions: {
            type: Array,
            value: () => { return MARKER_POSITIONS; }
          },
        }
      }

      static get observers() {
        return [
          '_updateDates(latestDateTs)',
        ]
      }

      _updateDates(latestDateTs) {
        const weekLooper = 6;
        let lastDate =
            latestDateTs ? new Date(latestDateTs) : new Date();
        this.splice('dates', 0, this.dates.length);
        this.splice('formattedDates', 0, this.formattedDates.length);
        for (let i = weekLooper; i >= 0; i--) {
          // date must be based on lastDate so setDate results in the
          // accurate month.
          let date = new Date(lastDate);
          date.setDate(lastDate.getDate() - i);
          this.push('dates', date);
          this.push('formattedDates',
            (`${date.getFullYear()}-${date.getMonth()+1}-${date.getDate()}`));
        }
      }

      _computeCurrentIncidents(incidents) {
        let currInc = [];
        incidents.forEach(incident => {
          if(incident['open']) {
            currInc.push(incident['severity'].toLowerCase());
          }
        });
        if (!currInc.length) { currInc.push('green'); }
        return currInc;
      }

      _computePreviousIncidents(incidents) {
        let prevInc = [];
        incidents.forEach(incident => {
          if (!incident['open']) {
            prevInc.push(incident);
          }
        });
        return prevInc;
      }

      _showToolTip(color) {
        return color != 'green';
      }
    }
    customElements.define(StatusTable.is, StatusTable);
  </script>
</dom-module>
