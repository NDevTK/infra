// Copyright 2018 The LUCI Authors. All rights reserved.
// Use of this source code is governed under the Apache License, Version 2.0
// that can be found in the LICENSE file.

syntax = "proto3";

import "infra/appengine/crosskylabadmin/api/fleet/v1/common.proto";

package crosskylabadmin.fleet;

option go_package = "fleet";


// Inventory service helps manage ChromeOS Dut Pools.
service Inventory {

  // ///////////////////////////////////////////////////////////////////////////
  // DUT pool balancing RPCs

  // EnsurePoolHealthy ensures that a target pool has only healthy DUTs.
  //
  // EnsurePoolHealthy works by swapping unhealthy DUTs from target pool with
  // healthy DUTs from a spare pool.
  rpc EnsurePoolHealthy(EnsurePoolHealthyRequest) returns
      (EnsurePoolHealthyResponse);

  rpc EnsurePoolHealthyForAllModels(EnsurePoolHealthyForAllModelsRequest)
          returns (EnsurePoolHealthyForAllModelsResponse);

  // ResizePool changes the size of the target DUT pool.
  //
  // ResizePool borrows or returns extra DUTs from the spare pool.
  //
  // ResizePool does not consider DUT health. Clients should usually call
  // EnsurePoolHealthy following a ResizePool operation.
  //
  // ResizePool never makes partial changes. In case of an error, no inventory
  // changes are made.
  rpc ResizePool(ResizePoolRequest) returns (ResizePoolResponse);

  // ///////////////////////////////////////////////////////////////////////////
  // Server database manipulation RPCs

  // RemoveDutsFromDrones removes the given duts from drones.
  rpc RemoveDutsFromDrones(RemoveDutsFromDronesRequest) returns (RemoveDutsFromDronesResponse);

  // AssignDutsToDrones assigns the given duts to drones.
  rpc AssignDutsToDrones(AssignDutsToDronesRequest) returns (AssignDutsToDronesResponse);

  // ListServers lists the servers in the current environment.
  rpc ListServers(ListServersRequest) returns (ListServersResponse);

  // ///////////////////////////////////////////////////////////////////////////
  // RPCs used internally by the infrastructure. Not for end-user tools.

  // UpdateDutLabels sets the SchedulableLabels of a DUT.
  //
  // This API should only be used by the Skylab infrastructure
  // internally.  It is used by repair tasks to update DUT labels.
  rpc UpdateDutLabels(UpdateDutLabelsRequest) returns (UpdateDutLabelsResponse);
}

message EnsurePoolHealthyRequest {
  // dut_selectors filters the set of DUTs considered by EnsurePoolHealthy.
  //
  // All pool changes occurs within this selected set of DUTs.
  // It is an error to omit dut_selector because that would allow
  // unconstrained DUT reallocation between pools, disregarding all other
  // labels.
  DutSelector dut_selector = 1;

  // target_pool is the pool that should contain healthy DUTs.
  string target_pool = 2;

  // spare_pool is the pool from which healthy DUTs will be swapped into
  // target_pool.
  string spare_pool = 3;

  // max_unhealthy_duts is the maximum number of DUTs that may be unhealthy in
  // the target pool before any action is taken.
  //
  // max_unhealthy_duts is meaningful only when it has a positive value (> 0).
  //
  // If the total number of unhealthy DUTs is above this threshold,
  // EnsurePoolHealthy does not change DUT pools and returns a
  // NOT_ENOUGH_HEALTHY_SPARES failure.
  int32 max_unhealthy_duts = 4;

  message Options {
    // If dryrun is true, no inventory changes are made. Proposed changes are
    // returned.
    bool dryrun = 1;
  }
  Options options = 5;
}

message EnsurePoolHealthyResponse {
  enum Failure {
    FAILURE_INVALID = 0;

    // Target pool had more than max_unhealthy_duts unhealthy duts before any
    // action was taken.
    TOO_MANY_UNHEALTHY_DUTS = 1;

    // Spare pool did not have enough healthy DUTs to make sure all DUTs in
    // target pool are healthy. In this failure mode, the available healthy
    // spare DUTs do get transferred to the target pool.
    NOT_ENOUGH_HEALTHY_SPARES = 2;
  }

  // Failures encountered during pool balancing.
  //
  // All the remaining fields of the response are still valid in the presence of
  // failures.
  repeated Failure failures = 1;

  // target_pool_status summarizes the target pool after the required
  // inventory changes are executed.
  //
  // Within the pool, only DUTs selected via dut_selector are summarized.
  PoolStatus target_pool_status = 2;

  // spare_pool_status summarizes the spare pool after the required
  // inventory changes are executed.
  //
  // Within the pool, only DUTs selected via dut_selector are summarized.
  PoolStatus spare_pool_status = 3;

  // url is an opaque URL for this inventory change.
  //
  // It is intended to be the gerrit CL corresponding to the change, or the
  // gitiles path for a committed changelist for the change.
  //
  // url is empty in dryrun mode.
  string url = 4;

  // changes correspond to the proposed or executed pool changes to ensure
  // inventory in response to various API methods calls.
  repeated PoolChange changes = 5;
}

message EnsurePoolHealthyForAllModelsRequest {
  // target_pool is the pool that should contain healthy DUTs.
  string target_pool = 1;

  // spare_pool is the pool from which healthy DUTs will be swapped into
  // target_pool.
  string spare_pool = 2;

  // max_unhealthy_duts is the maximum number of DUTs that may be unhealthy in
  // the target pool before any action is taken.
  //
  // max_unhealthy_duts is meaningful only when it has a positive value (> 0).
  //
  // If the total number of unhealthy DUTs is above this threshold,
  // EnsurePoolHealthy does not change DUT pools and returns a
  // NOT_ENOUGH_HEALTHY_SPARES failure.
  int32 max_unhealthy_duts = 3;
}

message EnsurePoolHealthyForAllModelsResponse {
  // model_result maps a model to the EnsurePoolHealthyResponse for that model.
  map<string, EnsurePoolHealthyResponse> model_result = 1;
}

message ResizePoolRequest {
  // dut_selectors filters the set of DUTs considered by ResizePool.
  //
  // All pool changes occurs within this selected set of DUTs.
  // It is an error to omit dut_selector because that would allow
  // unconstrained DUT reallocation between pools, disregarding all other
  // labels.
  DutSelector dut_selector = 1;

  // target_pool is the pool that should contain healthy DUTs.
  string target_pool = 2;

  // target_pool_size is the requested size for the target_pool.
  int32 target_pool_size = 3;

  // spare_pool is the pool to borrow needed DUTs from and return extra DUTs to.
  string spare_pool = 4;
}

message ResizePoolResponse {
  // url is an opaque URL for this inventory change.
  //
  // It is intended to be the gerrit CL corresponding to the change, or the
  // gitiles path for a committed changelist for the change.
  string url = 1;

  // changes correspond to the proposed or executed pool changes to inventory in
  // response to the ResizePool RPC.
  repeated PoolChange changes = 2;
}

message DutSelector {
  string model = 1;
}

message PoolStatus {
  // size is the number of DUTs in this pool.
  int32 size = 1;

  // healthy_count is the number of healthy DUTs in this pool.
  int32 healthy_count = 2;
}

// PoolChange is a single change of DUT pools in the inventory.
message PoolChange {
  // dut_id is the inventory ID of the DUT whose pool was modified.
  string dut_id = 1;

  // old_pool is the pool the DUT was removed from.
  string old_pool = 2;

  // new_pool is the pool the DUT was moved to.
  string new_pool = 3;
}

message RemoveDutsFromDronesRequest {

  message Item {
    // dut_id is the id of a dut to be removed.
    string dut_id = 1;

    // drone_hostname is the drone to remove the dut from (if specified); if unspecified
    // dut will be removed regardless of current drone.
    string drone_hostname = 2;
  }

  // removals is the set of Duts to remove.
  repeated Item removals = 1;
}

message RemoveDutsFromDronesResponse {

  message Item {
    // dut_id is the id of a dut that was removed.
    string dut_id = 1;

    // drone_hostname is the hostname of the drone that it the Dut was removed from.
    string drone_hostname = 2;
  }

  // removed is the set of Duts that were removed.
  repeated Item removed = 1;

  // url is an opaque URL for this inventory change.
  //
  // It is intended to be the gerrit CL corresponding to the change, or the
  // gitiles path for a committed changelist for the change.
  string url = 2;
}

message AssignDutsToDronesRequest {

  message Item {
    // dut_id is the id of a dut to assign to a drone.
    string dut_id = 1;

    // drone_hostname is the drone to assign the dut to.
    //
    // [not yet implemented] if absent, inventory service will use a heuristic to select
    // drone.
    string drone_hostname = 2;
  }

  // assignments is the set of Duts to assign.
  repeated Item assignments = 1;
}

message AssignDutsToDronesResponse {

  message Item {
    // dut_id is the id of a dut that was assigned to a drone.
    string dut_id = 1;

    // drone_hostname is the drone the dut was assigned to.
    string drone_hostname = 2;
  }

  // assigned is the set of Duts that were removed.
  repeated Item assigned = 1;

  // url is an opaque URL for this inventory change.
  //
  // It is intended to be the gerrit CL corresponding to the change, or the
  // gitiles path for a committed changelist for the change.
  string url = 2;
}

message ListServersRequest {
  message Filter {
    // Role of servers to list; if absent, list servers of all roles.
    ServerRole role = 1;
  }

  Filter filter = 1;
}

message ListServersResponse {
  repeated Server servers = 1;
}

message UpdateDutLabelsRequest {
  string dut_id = 1;
  // labels are the labels for the DUT that the client changed.  This
  // should be a serialized protobuf of inventory.SchedulableLabels.
  // Any labels that shouldn't be updated are ignored.
  bytes labels = 2;
  // reason is some string to provide context for the update.  This
  // should contain a URL to the task that triggered the change.  This
  // should not be capitalized since it will get formatted with other
  // information.
  string reason = 3;
}

message UpdateDutLabelsResponse {
  // url is a URL associated with the label update.
  //
  // It is usually a Gerrit or Gitiles URL.
  string url = 1;
}
