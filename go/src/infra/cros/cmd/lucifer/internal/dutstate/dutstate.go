// Copyright 2020 The Chromium Authors
// Use of this source code is governed by a BSD-style license that can be
// found in the LICENSE file.

package dutstate

import (
	"io/ioutil"
	"log"
	"path/filepath"

	"infra/cros/cmd/lucifer/internal/event"
)

const dutStateFilename = "dut_state.repair"

// ReadFile reads DUT state from dut_state.repair file and convert it to the event.
//
// The file will be exist if admin task requires to set special state to the DUT.
func ReadFile(resultsDir string) event.Event {
	if resultsDir == "" {
		return ""
	}

	path := filepath.Join(resultsDir, dutStateFilename)
	data, err := ioutil.ReadFile(path)
	if err != nil {
		log.Println(err)
		return ""
	}
	state := string(data)
	log.Printf("The file %q contains DUT state: %q", path, state)
	return convertDUTStateToEvent(state)
}

// specialEvents represents list of expected special Events from admin tasks.
var specialEvents = map[event.Event]bool{
	event.HostNeedsManualRepair: true,
	event.HostNeedsReplacement:  true,
	event.HostNeedsDeploy:       true,
}

// convertDUTStateToEvent converts DUT state to the Event.
//
// The Event has to be present specialEvents set.
// The Event is a state with prefix 'host_'.
func convertDUTStateToEvent(state string) event.Event {
	if state == "" {
		return ""
	}
	e := event.Event("host_" + state)
	if _, ok := specialEvents[e]; ok {
		return e
	}
	log.Printf("unexpected DUT state: %q", state)
	return ""
}

// successfulEvents represents list of Events considered successful result of process.
var successfulEvents = map[event.Event]bool{
	event.HostNeedsReplacement: true,
	event.HostNeedsDeploy:      true,
}

// IsSuccessState checks if the state is successful state.
//
// Only for state read from dut_state.repair file.
func IsSuccessState(e event.Event) bool {
	if e != "" {
		if _, ok := successfulEvents[e]; ok {
			return true
		}
	}
	return false
}
