{
  "plans": [
    {
      "name": "cros",
      "critical_actions": [
        {
          "name": "Set state: needs_deploy",
          "docs": [
            "The action set devices with request to be redeployed."
          ],
          "exec_name": "dut_set_state",
          "exec_args": [
            "state:needs_deploy"
          ],
          "run_control": "RUN_ONCE"
        },
        {
          "name": "Check stable versions exist",
          "docs": [
            "Check the DUT has model specific cros, firmware and faft stable_version configured."
          ],
          "conditions": [
            {
              "name": "Has a stable-version service",
              "docs": [
                "Verify if we have access to the service provided access to the stable version"
              ],
              "exec_name": "has_stable_version_service_path",
              "run_control": "RUN_ONCE"
            }
          ],
          "dependencies": [
            {
              "name": "Recovery version has OS image path",
              "docs": [
                "Verify that recovery version has OS image path."
              ],
              "dependencies": [
                {
                  "name": "Has a stable-version service",
                  "docs": [
                    "Verify if we have access to the service provided access to the stable version"
                  ],
                  "exec_name": "has_stable_version_service_path",
                  "run_control": "RUN_ONCE"
                }
              ],
              "exec_name": "has_stable_version_cros_image",
              "run_control": "RERUN_AFTER_RECOVERY"
            },
            {
              "name": "Check stable firmware version exists",
              "docs": [
                "Check the DUT has model specific firmware stable_version configured.",
                "Flex device are exampted from this check as they don't run cros firmware"
              ],
              "conditions": [
                {
                  "name": "Is a Chromebook",
                  "docs": [
                    "Check that DUT is a Chromebook by checking for non-Chromebook boards"
                  ],
                  "exec_name": "dut_check_board",
                  "exec_args": [
                    "string_values:aurora,reven",
                    "invert_result:true"
                  ],
                  "run_control": "RERUN_AFTER_RECOVERY"
                },
                {
                  "name": "Has a stable-version service",
                  "docs": [
                    "Verify if we have access to the service provided access to the stable version"
                  ],
                  "exec_name": "has_stable_version_service_path",
                  "run_control": "RUN_ONCE"
                }
              ],
              "exec_name": "has_stable_version_fw_version",
              "run_control": "RERUN_AFTER_RECOVERY"
            }
          ],
          "exec_name": "sample_pass",
          "run_control": "RERUN_AFTER_RECOVERY"
        },
        {
          "name": "Device is SSHable",
          "docs": [
            "Verify that device is reachable by SSH.",
            "Limited to 15 seconds."
          ],
          "exec_name": "cros_ssh",
          "timeout": "15s",
          "recoveries": [
            {
              "name": "Power cycle DUT by RPM and wait",
              "docs": [
                "Perform RPM cycle and wait to device to boot back."
              ],
              "conditions": [
                {
                  "name": "has_rpm_info",
                  "exec_name": "has_rpm_info",
                  "run_control": "RERUN_AFTER_RECOVERY"
                }
              ],
              "dependencies": [
                {
                  "name": "rpm_power_cycle",
                  "exec_name": "rpm_power_cycle",
                  "run_control": "RERUN_AFTER_RECOVERY"
                },
                {
                  "name": "Wait to be pingable (normal boot)",
                  "docs": [
                    "Wait DUT to be pingable after some action on it.",
                    "Waiting time 150 seconds."
                  ],
                  "exec_name": "cros_ping",
                  "timeout": "2m30s",
                  "run_control": "ALWAYS_RUN"
                }
              ],
              "exec_name": "sample_pass",
              "run_control": "ALWAYS_RUN"
            }
          ],
          "run_control": "ALWAYS_RUN"
        },
        {
          "name": "DUT has expected dev firmware (for browser DUTs)",
          "docs": [
            "Verify that FW on the DUT has dev keys."
          ],
          "conditions": [
            {
              "name": "dut_is_not_browser_legacy_duts",
              "exec_name": "dut_is_not_browser_legacy_duts",
              "run_control": "RERUN_AFTER_RECOVERY"
            }
          ],
          "dependencies": [
            {
              "name": "Device is SSHable",
              "docs": [
                "Verify that device is reachable by SSH.",
                "Limited to 15 seconds."
              ],
              "exec_name": "cros_ssh",
              "timeout": "15s",
              "recoveries": [
                {
                  "name": "Power cycle DUT by RPM and wait",
                  "docs": [
                    "Perform RPM cycle and wait to device to boot back."
                  ],
                  "conditions": [
                    {
                      "name": "has_rpm_info",
                      "exec_name": "has_rpm_info",
                      "run_control": "RERUN_AFTER_RECOVERY"
                    }
                  ],
                  "dependencies": [
                    {
                      "name": "rpm_power_cycle",
                      "exec_name": "rpm_power_cycle",
                      "run_control": "RERUN_AFTER_RECOVERY"
                    },
                    {
                      "name": "Wait to be pingable (normal boot)",
                      "docs": [
                        "Wait DUT to be pingable after some action on it.",
                        "Waiting time 150 seconds."
                      ],
                      "exec_name": "cros_ping",
                      "timeout": "2m30s",
                      "run_control": "ALWAYS_RUN"
                    }
                  ],
                  "exec_name": "sample_pass",
                  "run_control": "ALWAYS_RUN"
                }
              ],
              "run_control": "ALWAYS_RUN"
            }
          ],
          "exec_name": "cros_has_dev_signed_firmware",
          "timeout": "10m0s",
          "recoveries": [
            {
              "name": "Update DUT firmware with factory mode and restart by host",
              "docs": [
                "Force update FW on the DUT by factory mode.",
                "Reboot device by host"
              ],
              "dependencies": [
                {
                  "name": "Device is SSHable",
                  "docs": [
                    "Verify that device is reachable by SSH.",
                    "Limited to 15 seconds."
                  ],
                  "exec_name": "cros_ssh",
                  "timeout": "15s",
                  "run_control": "ALWAYS_RUN"
                },
                {
                  "name": "Collect HWID into inventory",
                  "docs": [
                    "Collect DUT hwid and update it into inventory info."
                  ],
                  "dependencies": [
                    {
                      "name": "Read HWID from DUT",
                      "conditions": [
                        {
                          "name": "Not Satlab device",
                          "docs": [
                            "Verify that DUT name is not belong Satlab."
                          ],
                          "conditions": [
                            {
                              "name": "Is Satlab device",
                              "docs": [
                                "Verify that DUT name is belong Satlab."
                              ],
                              "exec_name": "dut_regex_name_match",
                              "exec_args": [
                                "regex:^satlab"
                              ],
                              "run_control": "RERUN_AFTER_RECOVERY"
                            }
                          ],
                          "exec_name": "sample_fail",
                          "run_control": "RERUN_AFTER_RECOVERY"
                        }
                      ],
                      "exec_name": "cros_update_hwid_to_inventory",
                      "run_control": "ALWAYS_RUN"
                    },
                    {
                      "name": "Read HWID from DUT (Satlab)",
                      "conditions": [
                        {
                          "name": "Is Satlab device",
                          "docs": [
                            "Verify that DUT name is belong Satlab."
                          ],
                          "exec_name": "dut_regex_name_match",
                          "exec_args": [
                            "regex:^satlab"
                          ],
                          "run_control": "RERUN_AFTER_RECOVERY"
                        }
                      ],
                      "exec_name": "cros_update_hwid_to_inventory",
                      "allow_fail_after_recovery": true,
                      "run_control": "ALWAYS_RUN"
                    }
                  ],
                  "exec_name": "sample_pass",
                  "run_control": "RUN_ONCE"
                },
                {
                  "name": "Disable software-controlled write-protect for 'internal'",
                  "docs": [
                    "Disable write-protect fprom 'internal'."
                  ],
                  "dependencies": [
                    {
                      "name": "Device is SSHable",
                      "docs": [
                        "Verify that device is reachable by SSH.",
                        "Limited to 15 seconds."
                      ],
                      "exec_name": "cros_ssh",
                      "timeout": "15s",
                      "run_control": "ALWAYS_RUN"
                    }
                  ],
                  "exec_name": "cros_disable_fprom_write_protect",
                  "exec_args": [
                    "fprom:internal"
                  ],
                  "timeout": "5m0s",
                  "allow_fail_after_recovery": true,
                  "run_control": "ALWAYS_RUN"
                },
                {
                  "name": "Disable software-controlled write-protect for 'ec'",
                  "docs": [
                    "Disable write-protect fprom 'ec'."
                  ],
                  "dependencies": [
                    {
                      "name": "Device is SSHable",
                      "docs": [
                        "Verify that device is reachable by SSH.",
                        "Limited to 15 seconds."
                      ],
                      "exec_name": "cros_ssh",
                      "timeout": "15s",
                      "run_control": "ALWAYS_RUN"
                    }
                  ],
                  "exec_name": "cros_disable_fprom_write_protect",
                  "exec_args": [
                    "fprom:ec"
                  ],
                  "timeout": "5m0s",
                  "allow_fail_after_recovery": true,
                  "run_control": "ALWAYS_RUN"
                },
                {
                  "name": "Try to update FW from firmware image with factory mode",
                  "docs": [
                    "Download firmware image to DUT, and install via firmware updater.",
                    "Update firmware from faft stable image with chromeos-firmwareupdate tool",
                    "--mode=facotry will be specified when run chromeos-firmwareupdate",
                    "Set timeout to 120 minutes = 10 minutes for download + 100 minutes for find and extract AP/EC images + 10 minutes for run updater."
                  ],
                  "conditions": [
                    {
                      "name": "has_stable_version_fw_image",
                      "exec_name": "has_stable_version_fw_image",
                      "run_control": "RERUN_AFTER_RECOVERY"
                    }
                  ],
                  "exec_name": "cros_update_firmware_from_firmware_image",
                  "exec_args": [
                    "mode:factory",
                    "force:true",
                    "updater_timeout:600",
                    "update_ec_attempt_count:1",
                    "update_ap_attempt_count:1",
                    "use_cache_extractor:true"
                  ],
                  "timeout": "2h0m0s",
                  "allow_fail_after_recovery": true,
                  "run_control": "ALWAYS_RUN"
                },
                {
                  "name": "Try to update FW from OS image with factory mode",
                  "docs": [
                    "Run chromeos-firmwareupdate with factory mode.",
                    "The reboot is not triggered as part of the action.",
                    "The action is not strict to not block repair actions.",
                    "Only runs when the DUT doesn't have a model specific faft stable_version, e.g. it's an early stage device use satlab or flex device."
                  ],
                  "conditions": [
                    {
                      "name": "Missing stable fw image",
                      "docs": [
                        "Verify that the DUT doesn't have model specific stable_version record in faft section"
                      ],
                      "conditions": [
                        {
                          "name": "has_stable_version_fw_image",
                          "exec_name": "has_stable_version_fw_image",
                          "run_control": "RERUN_AFTER_RECOVERY"
                        }
                      ],
                      "exec_name": "sample_fail",
                      "run_control": "RERUN_AFTER_RECOVERY"
                    }
                  ],
                  "exec_name": "cros_run_firmware_update",
                  "exec_args": [
                    "mode:factory",
                    "force:true",
                    "updater_timeout:600"
                  ],
                  "timeout": "15m0s",
                  "allow_fail_after_recovery": true,
                  "run_control": "ALWAYS_RUN"
                },
                {
                  "name": "Simple reboot",
                  "docs": [
                    "Simple un-blocker reboot."
                  ],
                  "dependencies": [
                    {
                      "name": "Device is SSHable",
                      "docs": [
                        "Verify that device is reachable by SSH.",
                        "Limited to 15 seconds."
                      ],
                      "exec_name": "cros_ssh",
                      "timeout": "15s",
                      "run_control": "ALWAYS_RUN"
                    }
                  ],
                  "exec_name": "cros_run_command",
                  "exec_args": [
                    "host:dut",
                    "command:reboot",
                    "background:true"
                  ],
                  "run_control": "ALWAYS_RUN"
                },
                {
                  "name": "Wait to be SSHable (normal boot)",
                  "docs": [
                    "Try to wait device to be sshable after the device being rebooted.",
                    "Waiting time 150 seconds."
                  ],
                  "exec_name": "cros_ssh",
                  "timeout": "2m30s",
                  "run_control": "ALWAYS_RUN"
                }
              ],
              "exec_name": "sample_pass",
              "run_control": "ALWAYS_RUN"
            }
          ],
          "run_control": "RERUN_AFTER_RECOVERY"
        },
        {
          "name": "Update inventory info",
          "docs": [
            "Updating device info in inventory."
          ],
          "dependencies": [
            {
              "name": "cros_ssh",
              "exec_name": "cros_ssh",
              "run_control": "RERUN_AFTER_RECOVERY"
            },
            {
              "name": "cros_update_hwid_to_inventory",
              "exec_name": "cros_update_hwid_to_inventory",
              "run_control": "RERUN_AFTER_RECOVERY"
            },
            {
              "name": "cros_update_serial_number_inventory",
              "exec_name": "cros_update_serial_number_inventory",
              "run_control": "RERUN_AFTER_RECOVERY"
            }
          ],
          "exec_name": "sample_pass",
          "run_control": "RERUN_AFTER_RECOVERY"
        },
        {
          "name": "Set state: ready",
          "docs": [
            "The action set devices with state ready for the testing."
          ],
          "dependencies": [
            {
              "name": "All repair-requests resolved",
              "docs": [
                "Checks if all repair requests are resolved"
              ],
              "exec_name": "dut_has_no_repair_requests",
              "run_control": "RERUN_AFTER_RECOVERY"
            },
            {
              "name": "Reset DUT-state reason",
              "docs": [
                "Reset DUT-state-reason for good DUT as it becomes stale."
              ],
              "exec_name": "dut_reset_state_reason",
              "run_control": "RERUN_AFTER_RECOVERY"
            }
          ],
          "exec_name": "dut_set_state",
          "exec_args": [
            "state:ready"
          ],
          "run_control": "RUN_ONCE"
        }
      ]
    }
  ]
}