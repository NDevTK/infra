{
  "plans": [
    {
      "name": "cros",
      "critical_actions": [
        {
          "name": "Set state: needs_repair",
          "docs": [
            "The action set devices with state means that repair tsk did not success to recover the devices."
          ],
          "exec_name": "dut_set_state",
          "exec_args": [
            "state:needs_repair"
          ],
          "run_control": "RUN_ONCE"
        },
        {
          "name": "Device is SSHable",
          "docs": [
            "Verify that device is reachable by SSH.",
            "Limited to 15 seconds."
          ],
          "exec_name": "cros_ssh",
          "timeout": "15s",
          "recoveries": [
            {
              "name": "Cold reset by servo and wait for SSH",
              "docs": [
                "This repair action will use servod command to reset power_state on the DUT.",
                "TODO: (blocked by: b/221083688) Collect logs from a successfully repaired DUT."
              ],
              "conditions": [
                {
                  "name": "Is servod running",
                  "docs": [
                    "Verify that servo host specified in setup and servod is running."
                  ],
                  "dependencies": [
                    {
                      "name": "Setup has servo info",
                      "exec_name": "dut_servo_host_present",
                      "run_control": "RERUN_AFTER_RECOVERY"
                    },
                    {
                      "name": "Verify servod is responsive",
                      "conditions": [
                        {
                          "name": "Setup has servo info",
                          "exec_name": "dut_servo_host_present",
                          "run_control": "RERUN_AFTER_RECOVERY"
                        }
                      ],
                      "exec_name": "servod_echo",
                      "exec_args": [
                        "ssh_check:false"
                      ],
                      "timeout": "10s",
                      "run_control": "ALWAYS_RUN"
                    }
                  ],
                  "exec_name": "sample_pass",
                  "run_control": "RERUN_AFTER_RECOVERY"
                }
              ],
              "dependencies": [
                {
                  "name": "Cold reset DUT by servo",
                  "docs": [
                    "Cold reset device by servo and do not wait."
                  ],
                  "dependencies": [
                    {
                      "name": "Is servod running",
                      "docs": [
                        "Verify that servo host specified in setup and servod is running."
                      ],
                      "dependencies": [
                        {
                          "name": "Setup has servo info",
                          "exec_name": "dut_servo_host_present",
                          "run_control": "RERUN_AFTER_RECOVERY"
                        },
                        {
                          "name": "Verify servod is responsive",
                          "conditions": [
                            {
                              "name": "Setup has servo info",
                              "exec_name": "dut_servo_host_present",
                              "run_control": "RERUN_AFTER_RECOVERY"
                            }
                          ],
                          "exec_name": "servod_echo",
                          "exec_args": [
                            "ssh_check:false"
                          ],
                          "timeout": "10s",
                          "run_control": "ALWAYS_RUN"
                        }
                      ],
                      "exec_name": "sample_pass",
                      "run_control": "RERUN_AFTER_RECOVERY"
                    }
                  ],
                  "exec_name": "servo_set",
                  "exec_args": [
                    "command:power_state",
                    "string_value:reset",
                    "timeout:30"
                  ],
                  "run_control": "ALWAYS_RUN"
                },
                {
                  "name": "Wait to be SSHable (normal boot)",
                  "docs": [
                    "Try to wait device to be sshable after the device being rebooted.",
                    "Waiting time 150 seconds."
                  ],
                  "exec_name": "cros_ssh",
                  "timeout": "2m30s",
                  "run_control": "ALWAYS_RUN"
                }
              ],
              "exec_name": "sample_pass",
              "run_control": "ALWAYS_RUN"
            },
            {
              "name": "Install OS in recovery mode by booting from servo USB-drive",
              "docs": [
                "This action installs the test image on DUT utilizing the features of servo.",
                "DUT will be booted in recovery mode."
              ],
              "conditions": [
                {
                  "name": "Is servod running",
                  "docs": [
                    "Verify that servo host specified in setup and servod is running."
                  ],
                  "dependencies": [
                    {
                      "name": "Setup has servo info",
                      "exec_name": "dut_servo_host_present",
                      "run_control": "RERUN_AFTER_RECOVERY"
                    },
                    {
                      "name": "Verify servod is responsive",
                      "conditions": [
                        {
                          "name": "Setup has servo info",
                          "exec_name": "dut_servo_host_present",
                          "run_control": "RERUN_AFTER_RECOVERY"
                        }
                      ],
                      "exec_name": "servod_echo",
                      "exec_args": [
                        "ssh_check:false"
                      ],
                      "timeout": "10s",
                      "run_control": "ALWAYS_RUN"
                    }
                  ],
                  "exec_name": "sample_pass",
                  "run_control": "RERUN_AFTER_RECOVERY"
                },
                {
                  "name": "Is not Flex device",
                  "docs": [
                    "Check that DUT is not a Flex board"
                  ],
                  "exec_name": "dut_check_board",
                  "exec_args": [
                    "string_values:aurora,reven",
                    "invert_result:true"
                  ],
                  "run_control": "RERUN_AFTER_RECOVERY"
                },
                {
                  "name": "Is servo USB key detected",
                  "docs": [
                    "The action used as codiion.",
                    "The action verify that USB-key is detected and readable."
                  ],
                  "dependencies": [
                    {
                      "name": "Is servod running",
                      "docs": [
                        "Verify that servo host specified in setup and servod is running."
                      ],
                      "dependencies": [
                        {
                          "name": "Setup has servo info",
                          "exec_name": "dut_servo_host_present",
                          "run_control": "RERUN_AFTER_RECOVERY"
                        },
                        {
                          "name": "Verify servod is responsive",
                          "conditions": [
                            {
                              "name": "Setup has servo info",
                              "exec_name": "dut_servo_host_present",
                              "run_control": "RERUN_AFTER_RECOVERY"
                            }
                          ],
                          "exec_name": "servod_echo",
                          "exec_args": [
                            "ssh_check:false"
                          ],
                          "timeout": "10s",
                          "run_control": "ALWAYS_RUN"
                        }
                      ],
                      "exec_name": "sample_pass",
                      "run_control": "RERUN_AFTER_RECOVERY"
                    }
                  ],
                  "exec_name": "servo_usbkey_is_detected",
                  "exec_args": [
                    "file_check:true"
                  ],
                  "run_control": "RERUN_AFTER_RECOVERY"
                }
              ],
              "dependencies": [
                {
                  "name": "Servo USB-Key needs to be reflashed",
                  "docs": [
                    "Check if it is time to download image to servo usbkey.",
                    "If so, then download the stable image to usbkey."
                  ],
                  "conditions": [
                    {
                      "name": "It is time to update USB-drive image",
                      "docs": [
                        "Check if it is time to force download image to usbkey",
                        "from the number of failed recoveries since last successful PARIS repair task."
                      ],
                      "exec_name": "cros_is_time_to_force_download_image_to_usbkey",
                      "exec_args": [
                        "task_name:recovery",
                        "repair_failed_count:1",
                        "repair_failed_interval:10"
                      ],
                      "run_control": "RERUN_AFTER_RECOVERY"
                    }
                  ],
                  "dependencies": [
                    {
                      "name": "Download stable image to USB-key",
                      "docs": [
                        "Download lab stable image on servo USB-key",
                        "Download the image can take longer if labstation download parallel a few images.",
                        "This step is allowed to complete successfully even if some",
                        " errors happen during download because the image can already",
                        " be present on the USB-drive."
                      ],
                      "dependencies": [
                        {
                          "name": "Setup has servo info",
                          "exec_name": "dut_servo_host_present",
                          "run_control": "RERUN_AFTER_RECOVERY"
                        },
                        {
                          "name": "Is servo USB key detected",
                          "docs": [
                            "The action used as codiion.",
                            "The action verify that USB-key is detected and readable."
                          ],
                          "dependencies": [
                            {
                              "name": "Is servod running",
                              "docs": [
                                "Verify that servo host specified in setup and servod is running."
                              ],
                              "dependencies": [
                                {
                                  "name": "Setup has servo info",
                                  "exec_name": "dut_servo_host_present",
                                  "run_control": "RERUN_AFTER_RECOVERY"
                                },
                                {
                                  "name": "Verify servod is responsive",
                                  "conditions": [
                                    {
                                      "name": "Setup has servo info",
                                      "exec_name": "dut_servo_host_present",
                                      "run_control": "RERUN_AFTER_RECOVERY"
                                    }
                                  ],
                                  "exec_name": "servod_echo",
                                  "exec_args": [
                                    "ssh_check:false"
                                  ],
                                  "timeout": "10s",
                                  "run_control": "ALWAYS_RUN"
                                }
                              ],
                              "exec_name": "sample_pass",
                              "run_control": "RERUN_AFTER_RECOVERY"
                            }
                          ],
                          "exec_name": "servo_usbkey_is_detected",
                          "exec_args": [
                            "file_check:true"
                          ],
                          "run_control": "RERUN_AFTER_RECOVERY"
                        },
                        {
                          "name": "Call servod to download image to USB-key",
                          "docs": [
                            "This action calls servod to download stable version OS image to servo USB-key."
                          ],
                          "exec_name": "servo_download_image_to_usb",
                          "timeout": "50m0s",
                          "run_control": "ALWAYS_RUN"
                        },
                        {
                          "name": "Remove UPDATE_USBKEY_IMAGE repair-request",
                          "docs": [
                            "Remove UPDATE_USBKEY_IMAGE from repair-requests."
                          ],
                          "exec_name": "dut_remove_repair_requests",
                          "exec_args": [
                            "requests:UPDATE_USBKEY_IMAGE"
                          ],
                          "run_control": "ALWAYS_RUN"
                        }
                      ],
                      "exec_name": "sample_pass",
                      "allow_fail_after_recovery": true,
                      "run_control": "ALWAYS_RUN"
                    }
                  ],
                  "exec_name": "sample_pass",
                  "run_control": "RERUN_AFTER_RECOVERY"
                },
                {
                  "name": "Download stable version OS image to servo usbkey if necessary (allow fail)",
                  "docs": [
                    "This action will download model specific stable version OS image to servo usbkey.",
                    "The action will be skipped if the required image is already loaded."
                  ],
                  "conditions": [
                    {
                      "name": "Setup has servo info",
                      "exec_name": "dut_servo_host_present",
                      "run_control": "RERUN_AFTER_RECOVERY"
                    },
                    {
                      "name": "Has a stable-version service",
                      "docs": [
                        "Verify if we have access to the service provided access to the stable version"
                      ],
                      "exec_name": "has_stable_version_service_path",
                      "run_control": "RUN_ONCE"
                    },
                    {
                      "name": "Stable version image is missing from servo usbkey",
                      "docs": [
                        "This is a reverse action which fails when required image is already cached in servo usbkey.",
                        "The purpose is to serve as a condition of Download stable image to USB-key action, so that we don't do duplicate download.",
                        "If this action fails, it means the servo usbkey already have required stable_version OS image cached."
                      ],
                      "conditions": [
                        {
                          "name": "Servo usbkey has stable image",
                          "docs": [
                            "Check if the usbkey has the stable_version OS image.",
                            "TODO: Collect data on the usual number of retries and tweak the default"
                          ],
                          "exec_name": "servo_usbkey_has_stable_image",
                          "exec_args": [
                            "retry_count:3",
                            "retry_interval:1",
                            "usb_file_check:true"
                          ],
                          "run_control": "RERUN_AFTER_RECOVERY"
                        }
                      ],
                      "exec_name": "sample_fail",
                      "run_control": "RERUN_AFTER_RECOVERY"
                    }
                  ],
                  "dependencies": [
                    {
                      "name": "servo_servod_echo_host",
                      "exec_name": "servo_servod_echo_host",
                      "run_control": "RERUN_AFTER_RECOVERY"
                    },
                    {
                      "name": "Is servo USB key detected",
                      "docs": [
                        "The action used as codiion.",
                        "The action verify that USB-key is detected and readable."
                      ],
                      "dependencies": [
                        {
                          "name": "Is servod running",
                          "docs": [
                            "Verify that servo host specified in setup and servod is running."
                          ],
                          "dependencies": [
                            {
                              "name": "Setup has servo info",
                              "exec_name": "dut_servo_host_present",
                              "run_control": "RERUN_AFTER_RECOVERY"
                            },
                            {
                              "name": "Verify servod is responsive",
                              "conditions": [
                                {
                                  "name": "Setup has servo info",
                                  "exec_name": "dut_servo_host_present",
                                  "run_control": "RERUN_AFTER_RECOVERY"
                                }
                              ],
                              "exec_name": "servod_echo",
                              "exec_args": [
                                "ssh_check:false"
                              ],
                              "timeout": "10s",
                              "run_control": "ALWAYS_RUN"
                            }
                          ],
                          "exec_name": "sample_pass",
                          "run_control": "RERUN_AFTER_RECOVERY"
                        }
                      ],
                      "exec_name": "servo_usbkey_is_detected",
                      "exec_args": [
                        "file_check:true"
                      ],
                      "run_control": "RERUN_AFTER_RECOVERY"
                    },
                    {
                      "name": "Call servod to download image to USB-key",
                      "docs": [
                        "This action calls servod to download stable version OS image to servo USB-key."
                      ],
                      "exec_name": "servo_download_image_to_usb",
                      "timeout": "50m0s",
                      "run_control": "ALWAYS_RUN"
                    },
                    {
                      "name": "Remove UPDATE_USBKEY_IMAGE repair-request",
                      "docs": [
                        "Remove UPDATE_USBKEY_IMAGE from repair-requests."
                      ],
                      "exec_name": "dut_remove_repair_requests",
                      "exec_args": [
                        "requests:UPDATE_USBKEY_IMAGE"
                      ],
                      "run_control": "ALWAYS_RUN"
                    }
                  ],
                  "exec_name": "sample_pass",
                  "allow_fail_after_recovery": true,
                  "run_control": "RUN_ONCE"
                },
                {
                  "name": "Boot DUT in recovery and install from USB-drive",
                  "docs": [
                    "This action installs the test image on DUT utilizing ",
                    "the features of servo. DUT will be booted in recovery ",
                    "mode. In some cases RO FW is not allowed to boot in ",
                    "recovery mode with active PD, so we will change it to ",
                    "sink-mode if required."
                  ],
                  "exec_name": "cros_install_in_recovery_mode",
                  "exec_args": [
                    "run_tpm_reset:true",
                    "run_os_install:true",
                    "boot_timeout:480",
                    "boot_interval:10",
                    "boot_retry:2",
                    "halt_timeout:120",
                    "install_timeout:1200",
                    "tpm_reset_timeout:60",
                    "post_install_boot_time:15",
                    "badblocks_mode:auto",
                    "rw_badblocks_timeout:5400",
                    "ro_badblocks_timeout:3600"
                  ],
                  "timeout": "2h13m20s",
                  "run_control": "ALWAYS_RUN"
                },
                {
                  "name": "Wait to be SSHable (normal boot)",
                  "docs": [
                    "Try to wait device to be sshable after the device being rebooted.",
                    "Waiting time 150 seconds."
                  ],
                  "exec_name": "cros_ssh",
                  "timeout": "2m30s",
                  "run_control": "ALWAYS_RUN"
                },
                {
                  "name": "Remove REIMAGE_BY_USBKEY repair-request",
                  "docs": [
                    "Remove REIMAGE_BY_USBKEY and PROVISION repair-requests."
                  ],
                  "exec_name": "dut_remove_repair_requests",
                  "exec_args": [
                    "requests:PROVISION,REIMAGE_BY_USBKEY"
                  ],
                  "run_control": "ALWAYS_RUN"
                }
              ],
              "exec_name": "sample_pass",
              "run_control": "ALWAYS_RUN"
            },
            {
              "name": "Update FW from fw-image by servo and wait for boot",
              "docs": [
                "This action will repair the firmware on the DUT, and ",
                "then reboot and wait for the DUT to again become ",
                "available. This action exists to wrap these component ",
                "actions into a single repair action."
              ],
              "conditions": [
                {
                  "name": "Is servod running",
                  "docs": [
                    "Verify that servo host specified in setup and servod is running."
                  ],
                  "dependencies": [
                    {
                      "name": "Setup has servo info",
                      "exec_name": "dut_servo_host_present",
                      "run_control": "RERUN_AFTER_RECOVERY"
                    },
                    {
                      "name": "Verify servod is responsive",
                      "conditions": [
                        {
                          "name": "Setup has servo info",
                          "exec_name": "dut_servo_host_present",
                          "run_control": "RERUN_AFTER_RECOVERY"
                        }
                      ],
                      "exec_name": "servod_echo",
                      "exec_args": [
                        "ssh_check:false"
                      ],
                      "timeout": "10s",
                      "run_control": "ALWAYS_RUN"
                    }
                  ],
                  "exec_name": "sample_pass",
                  "run_control": "RERUN_AFTER_RECOVERY"
                },
                {
                  "name": "Is not Flex device",
                  "docs": [
                    "Check that DUT is not a Flex board"
                  ],
                  "exec_name": "dut_check_board",
                  "exec_args": [
                    "string_values:aurora,reven",
                    "invert_result:true"
                  ],
                  "run_control": "RERUN_AFTER_RECOVERY"
                }
              ],
              "dependencies": [
                {
                  "name": "Flash EC (FW) by servo",
                  "docs": [
                    "Download fw-image specified in stable version and flash EC to the DUT by servo",
                    "Set timeout for 110 minutes for now as = 10m(download)+4*20m(find/extract file)+20m(ec-update with retry).",
                    "We will retry up to 5 times since there is flakiness on flash EC."
                  ],
                  "conditions": [
                    {
                      "name": "Is servod running",
                      "docs": [
                        "Verify that servo host specified in setup and servod is running."
                      ],
                      "dependencies": [
                        {
                          "name": "Setup has servo info",
                          "exec_name": "dut_servo_host_present",
                          "run_control": "RERUN_AFTER_RECOVERY"
                        },
                        {
                          "name": "Verify servod is responsive",
                          "conditions": [
                            {
                              "name": "Setup has servo info",
                              "exec_name": "dut_servo_host_present",
                              "run_control": "RERUN_AFTER_RECOVERY"
                            }
                          ],
                          "exec_name": "servod_echo",
                          "exec_args": [
                            "ssh_check:false"
                          ],
                          "timeout": "10s",
                          "run_control": "ALWAYS_RUN"
                        }
                      ],
                      "exec_name": "sample_pass",
                      "run_control": "RERUN_AFTER_RECOVERY"
                    }
                  ],
                  "dependencies": [
                    {
                      "name": "Recovery version has firmware image path",
                      "docs": [
                        "Verify that recovery version has firmware image path."
                      ],
                      "dependencies": [
                        {
                          "name": "Has a stable-version service",
                          "docs": [
                            "Verify if we have access to the service provided access to the stable version"
                          ],
                          "exec_name": "has_stable_version_service_path",
                          "run_control": "RUN_ONCE"
                        }
                      ],
                      "exec_name": "has_stable_version_fw_image",
                      "run_control": "RERUN_AFTER_RECOVERY"
                    }
                  ],
                  "exec_name": "cros_update_fw_with_fw_image_by_servo",
                  "exec_args": [
                    "update_ec_attempt_count:5",
                    "download_timeout:600",
                    "use_cache_extractor:true"
                  ],
                  "timeout": "1h50m0s",
                  "allow_fail_after_recovery": true,
                  "run_control": "RERUN_AFTER_RECOVERY"
                },
                {
                  "name": "Sleep 60 seconds",
                  "exec_name": "sample_sleep",
                  "exec_args": [
                    "sleep:60"
                  ],
                  "timeout": "1m10s",
                  "allow_fail_after_recovery": true,
                  "run_control": "ALWAYS_RUN"
                },
                {
                  "name": "Disable software write protection via servo",
                  "docs": [
                    "Disable software write protection(for flash firmware) via servo."
                  ],
                  "dependencies": [
                    {
                      "name": "Is servod running",
                      "docs": [
                        "Verify that servo host specified in setup and servod is running."
                      ],
                      "dependencies": [
                        {
                          "name": "Setup has servo info",
                          "exec_name": "dut_servo_host_present",
                          "run_control": "RERUN_AFTER_RECOVERY"
                        },
                        {
                          "name": "Verify servod is responsive",
                          "conditions": [
                            {
                              "name": "Setup has servo info",
                              "exec_name": "dut_servo_host_present",
                              "run_control": "RERUN_AFTER_RECOVERY"
                            }
                          ],
                          "exec_name": "servod_echo",
                          "exec_args": [
                            "ssh_check:false"
                          ],
                          "timeout": "10s",
                          "run_control": "ALWAYS_RUN"
                        }
                      ],
                      "exec_name": "sample_pass",
                      "run_control": "RERUN_AFTER_RECOVERY"
                    }
                  ],
                  "exec_name": "cros_disable_software_write_protection_by_servo",
                  "timeout": "1m0s",
                  "allow_fail_after_recovery": true,
                  "run_control": "RERUN_AFTER_RECOVERY"
                },
                {
                  "name": "Flash AP (FW) with GBB 0x18 by servo",
                  "docs": [
                    "Download fw-image specified in stable version and flash AP to the DUT by servo",
                    "Set timeout for 90 minutes for now as = 10m(download)+2*20m(find/extract file)+40m(ap-update with retry).",
                    "We will retry up to 3 times since there may be flakiness on flash AP via servo."
                  ],
                  "conditions": [
                    {
                      "name": "Is servod running",
                      "docs": [
                        "Verify that servo host specified in setup and servod is running."
                      ],
                      "dependencies": [
                        {
                          "name": "Setup has servo info",
                          "exec_name": "dut_servo_host_present",
                          "run_control": "RERUN_AFTER_RECOVERY"
                        },
                        {
                          "name": "Verify servod is responsive",
                          "conditions": [
                            {
                              "name": "Setup has servo info",
                              "exec_name": "dut_servo_host_present",
                              "run_control": "RERUN_AFTER_RECOVERY"
                            }
                          ],
                          "exec_name": "servod_echo",
                          "exec_args": [
                            "ssh_check:false"
                          ],
                          "timeout": "10s",
                          "run_control": "ALWAYS_RUN"
                        }
                      ],
                      "exec_name": "sample_pass",
                      "run_control": "RERUN_AFTER_RECOVERY"
                    }
                  ],
                  "dependencies": [
                    {
                      "name": "Recovery version has firmware image path",
                      "docs": [
                        "Verify that recovery version has firmware image path."
                      ],
                      "dependencies": [
                        {
                          "name": "Has a stable-version service",
                          "docs": [
                            "Verify if we have access to the service provided access to the stable version"
                          ],
                          "exec_name": "has_stable_version_service_path",
                          "run_control": "RUN_ONCE"
                        }
                      ],
                      "exec_name": "has_stable_version_fw_image",
                      "run_control": "RERUN_AFTER_RECOVERY"
                    }
                  ],
                  "exec_name": "cros_update_fw_with_fw_image_by_servo",
                  "exec_args": [
                    "update_ap_attempt_count:3",
                    "download_timeout:600",
                    "gbb_flags:0x18",
                    "use_cache_extractor:true"
                  ],
                  "timeout": "1h30m0s",
                  "allow_fail_after_recovery": true,
                  "run_control": "RERUN_AFTER_RECOVERY"
                },
                {
                  "name": "Wait to be SSHable (normal boot)",
                  "docs": [
                    "Try to wait device to be sshable after the device being rebooted.",
                    "Waiting time 150 seconds."
                  ],
                  "exec_name": "cros_ssh",
                  "timeout": "2m30s",
                  "run_control": "ALWAYS_RUN"
                }
              ],
              "exec_name": "sample_pass",
              "run_control": "RERUN_AFTER_RECOVERY"
            },
            {
              "name": "Install OS in recovery mode by booting from servo USB-drive (special pools)",
              "docs": [
                "This action installs the test image on DUT utilizing the features of servo.",
                "DUT will be booted in recovery mode. This action is targeted at devices ",
                "in special pools only."
              ],
              "conditions": [
                {
                  "name": "Pools allowed to stay in DEV mode",
                  "docs": [
                    "Verify that pools are allowed to stay in DEV mode."
                  ],
                  "exec_name": "dut_is_in_pool",
                  "exec_args": [
                    "crouton",
                    "faft-test",
                    "faft-test-au",
                    "faft-test-tot",
                    "nyc-meet-lab",
                    "satlab_faft"
                  ],
                  "run_control": "RERUN_AFTER_RECOVERY"
                },
                {
                  "name": "Recovery version has OS image path",
                  "docs": [
                    "Verify that recovery version has OS image path."
                  ],
                  "dependencies": [
                    {
                      "name": "Has a stable-version service",
                      "docs": [
                        "Verify if we have access to the service provided access to the stable version"
                      ],
                      "exec_name": "has_stable_version_service_path",
                      "run_control": "RUN_ONCE"
                    }
                  ],
                  "exec_name": "has_stable_version_cros_image",
                  "run_control": "RERUN_AFTER_RECOVERY"
                },
                {
                  "name": "Is servod running",
                  "docs": [
                    "Verify that servo host specified in setup and servod is running."
                  ],
                  "dependencies": [
                    {
                      "name": "Setup has servo info",
                      "exec_name": "dut_servo_host_present",
                      "run_control": "RERUN_AFTER_RECOVERY"
                    },
                    {
                      "name": "Verify servod is responsive",
                      "conditions": [
                        {
                          "name": "Setup has servo info",
                          "exec_name": "dut_servo_host_present",
                          "run_control": "RERUN_AFTER_RECOVERY"
                        }
                      ],
                      "exec_name": "servod_echo",
                      "exec_args": [
                        "ssh_check:false"
                      ],
                      "timeout": "10s",
                      "run_control": "ALWAYS_RUN"
                    }
                  ],
                  "exec_name": "sample_pass",
                  "run_control": "RERUN_AFTER_RECOVERY"
                },
                {
                  "name": "Is not Flex device",
                  "docs": [
                    "Check that DUT is not a Flex board"
                  ],
                  "exec_name": "dut_check_board",
                  "exec_args": [
                    "string_values:aurora,reven",
                    "invert_result:true"
                  ],
                  "run_control": "RERUN_AFTER_RECOVERY"
                },
                {
                  "name": "Is servo USB key detected",
                  "docs": [
                    "The action used as codiion.",
                    "The action verify that USB-key is detected and readable."
                  ],
                  "dependencies": [
                    {
                      "name": "Is servod running",
                      "docs": [
                        "Verify that servo host specified in setup and servod is running."
                      ],
                      "dependencies": [
                        {
                          "name": "Setup has servo info",
                          "exec_name": "dut_servo_host_present",
                          "run_control": "RERUN_AFTER_RECOVERY"
                        },
                        {
                          "name": "Verify servod is responsive",
                          "conditions": [
                            {
                              "name": "Setup has servo info",
                              "exec_name": "dut_servo_host_present",
                              "run_control": "RERUN_AFTER_RECOVERY"
                            }
                          ],
                          "exec_name": "servod_echo",
                          "exec_args": [
                            "ssh_check:false"
                          ],
                          "timeout": "10s",
                          "run_control": "ALWAYS_RUN"
                        }
                      ],
                      "exec_name": "sample_pass",
                      "run_control": "RERUN_AFTER_RECOVERY"
                    }
                  ],
                  "exec_name": "servo_usbkey_is_detected",
                  "exec_args": [
                    "file_check:true"
                  ],
                  "run_control": "RERUN_AFTER_RECOVERY"
                }
              ],
              "dependencies": [
                {
                  "name": "Boot DUT in recovery and install from USB-drive",
                  "docs": [
                    "This action installs the test image on DUT utilizing ",
                    "the features of servo. DUT will be booted in recovery ",
                    "mode. In some cases RO FW is not allowed to boot in ",
                    "recovery mode with active PD, so we will change it to ",
                    "sink-mode if required."
                  ],
                  "exec_name": "cros_install_in_recovery_mode",
                  "exec_args": [
                    "run_tpm_reset:true",
                    "run_os_install:true",
                    "boot_timeout:480",
                    "boot_interval:10",
                    "boot_retry:2",
                    "halt_timeout:120",
                    "install_timeout:1200",
                    "tpm_reset_timeout:60",
                    "post_install_boot_time:15",
                    "badblocks_mode:auto",
                    "rw_badblocks_timeout:5400",
                    "ro_badblocks_timeout:3600"
                  ],
                  "timeout": "2h13m20s",
                  "run_control": "ALWAYS_RUN"
                },
                {
                  "name": "Wait to be SSHable (normal boot)",
                  "docs": [
                    "Try to wait device to be sshable after the device being rebooted.",
                    "Waiting time 150 seconds."
                  ],
                  "exec_name": "cros_ssh",
                  "timeout": "2m30s",
                  "run_control": "ALWAYS_RUN"
                },
                {
                  "name": "Remove REIMAGE_BY_USBKEY repair-request",
                  "docs": [
                    "Remove REIMAGE_BY_USBKEY and PROVISION repair-requests."
                  ],
                  "exec_name": "dut_remove_repair_requests",
                  "exec_args": [
                    "requests:PROVISION,REIMAGE_BY_USBKEY"
                  ],
                  "run_control": "ALWAYS_RUN"
                }
              ],
              "exec_name": "sample_pass",
              "run_control": "ALWAYS_RUN"
            },
            {
              "name": "Install OS in recovery mode by booting from servo USB-drive (Flex)",
              "docs": [
                "The action design only for Flex devices.",
                "This action installs the test image on DUT utilizing the features of servo.",
                "When DUT sees USB-key it will always try to boot from it."
              ],
              "conditions": [
                {
                  "name": "Is Flex device",
                  "docs": [
                    "Check that DUT is a Flex board"
                  ],
                  "exec_name": "dut_check_board",
                  "exec_args": [
                    "string_values:aurora,reven",
                    "invert_result:false"
                  ],
                  "run_control": "RERUN_AFTER_RECOVERY"
                },
                {
                  "name": "Is servod running",
                  "docs": [
                    "Verify that servo host specified in setup and servod is running."
                  ],
                  "dependencies": [
                    {
                      "name": "Setup has servo info",
                      "exec_name": "dut_servo_host_present",
                      "run_control": "RERUN_AFTER_RECOVERY"
                    },
                    {
                      "name": "Verify servod is responsive",
                      "conditions": [
                        {
                          "name": "Setup has servo info",
                          "exec_name": "dut_servo_host_present",
                          "run_control": "RERUN_AFTER_RECOVERY"
                        }
                      ],
                      "exec_name": "servod_echo",
                      "exec_args": [
                        "ssh_check:false"
                      ],
                      "timeout": "10s",
                      "run_control": "ALWAYS_RUN"
                    }
                  ],
                  "exec_name": "sample_pass",
                  "run_control": "RERUN_AFTER_RECOVERY"
                },
                {
                  "name": "Is servo USB key detected",
                  "docs": [
                    "The action used as codiion.",
                    "The action verify that USB-key is detected and readable."
                  ],
                  "dependencies": [
                    {
                      "name": "Is servod running",
                      "docs": [
                        "Verify that servo host specified in setup and servod is running."
                      ],
                      "dependencies": [
                        {
                          "name": "Setup has servo info",
                          "exec_name": "dut_servo_host_present",
                          "run_control": "RERUN_AFTER_RECOVERY"
                        },
                        {
                          "name": "Verify servod is responsive",
                          "conditions": [
                            {
                              "name": "Setup has servo info",
                              "exec_name": "dut_servo_host_present",
                              "run_control": "RERUN_AFTER_RECOVERY"
                            }
                          ],
                          "exec_name": "servod_echo",
                          "exec_args": [
                            "ssh_check:false"
                          ],
                          "timeout": "10s",
                          "run_control": "ALWAYS_RUN"
                        }
                      ],
                      "exec_name": "sample_pass",
                      "run_control": "RERUN_AFTER_RECOVERY"
                    }
                  ],
                  "exec_name": "servo_usbkey_is_detected",
                  "exec_args": [
                    "file_check:true"
                  ],
                  "run_control": "RERUN_AFTER_RECOVERY"
                }
              ],
              "dependencies": [
                {
                  "name": "Servo USB-Key needs to be reflashed",
                  "docs": [
                    "Check if it is time to download image to servo usbkey.",
                    "If so, then download the stable image to usbkey."
                  ],
                  "conditions": [
                    {
                      "name": "It is time to update USB-drive image",
                      "docs": [
                        "Check if it is time to force download image to usbkey",
                        "from the number of failed recoveries since last successful PARIS repair task."
                      ],
                      "exec_name": "cros_is_time_to_force_download_image_to_usbkey",
                      "exec_args": [
                        "task_name:recovery",
                        "repair_failed_count:1",
                        "repair_failed_interval:10"
                      ],
                      "run_control": "RERUN_AFTER_RECOVERY"
                    }
                  ],
                  "dependencies": [
                    {
                      "name": "Download stable image to USB-key",
                      "docs": [
                        "Download lab stable image on servo USB-key",
                        "Download the image can take longer if labstation download parallel a few images.",
                        "This step is allowed to complete successfully even if some",
                        " errors happen during download because the image can already",
                        " be present on the USB-drive."
                      ],
                      "dependencies": [
                        {
                          "name": "Setup has servo info",
                          "exec_name": "dut_servo_host_present",
                          "run_control": "RERUN_AFTER_RECOVERY"
                        },
                        {
                          "name": "Is servo USB key detected",
                          "docs": [
                            "The action used as codiion.",
                            "The action verify that USB-key is detected and readable."
                          ],
                          "dependencies": [
                            {
                              "name": "Is servod running",
                              "docs": [
                                "Verify that servo host specified in setup and servod is running."
                              ],
                              "dependencies": [
                                {
                                  "name": "Setup has servo info",
                                  "exec_name": "dut_servo_host_present",
                                  "run_control": "RERUN_AFTER_RECOVERY"
                                },
                                {
                                  "name": "Verify servod is responsive",
                                  "conditions": [
                                    {
                                      "name": "Setup has servo info",
                                      "exec_name": "dut_servo_host_present",
                                      "run_control": "RERUN_AFTER_RECOVERY"
                                    }
                                  ],
                                  "exec_name": "servod_echo",
                                  "exec_args": [
                                    "ssh_check:false"
                                  ],
                                  "timeout": "10s",
                                  "run_control": "ALWAYS_RUN"
                                }
                              ],
                              "exec_name": "sample_pass",
                              "run_control": "RERUN_AFTER_RECOVERY"
                            }
                          ],
                          "exec_name": "servo_usbkey_is_detected",
                          "exec_args": [
                            "file_check:true"
                          ],
                          "run_control": "RERUN_AFTER_RECOVERY"
                        },
                        {
                          "name": "Call servod to download image to USB-key",
                          "docs": [
                            "This action calls servod to download stable version OS image to servo USB-key."
                          ],
                          "exec_name": "servo_download_image_to_usb",
                          "timeout": "50m0s",
                          "run_control": "ALWAYS_RUN"
                        },
                        {
                          "name": "Remove UPDATE_USBKEY_IMAGE repair-request",
                          "docs": [
                            "Remove UPDATE_USBKEY_IMAGE from repair-requests."
                          ],
                          "exec_name": "dut_remove_repair_requests",
                          "exec_args": [
                            "requests:UPDATE_USBKEY_IMAGE"
                          ],
                          "run_control": "ALWAYS_RUN"
                        }
                      ],
                      "exec_name": "sample_pass",
                      "allow_fail_after_recovery": true,
                      "run_control": "ALWAYS_RUN"
                    }
                  ],
                  "exec_name": "sample_pass",
                  "run_control": "RERUN_AFTER_RECOVERY"
                },
                {
                  "name": "Download stable version OS image to servo usbkey if necessary (allow fail)",
                  "docs": [
                    "This action will download model specific stable version OS image to servo usbkey.",
                    "The action will be skipped if the required image is already loaded."
                  ],
                  "conditions": [
                    {
                      "name": "Setup has servo info",
                      "exec_name": "dut_servo_host_present",
                      "run_control": "RERUN_AFTER_RECOVERY"
                    },
                    {
                      "name": "Has a stable-version service",
                      "docs": [
                        "Verify if we have access to the service provided access to the stable version"
                      ],
                      "exec_name": "has_stable_version_service_path",
                      "run_control": "RUN_ONCE"
                    },
                    {
                      "name": "Stable version image is missing from servo usbkey",
                      "docs": [
                        "This is a reverse action which fails when required image is already cached in servo usbkey.",
                        "The purpose is to serve as a condition of Download stable image to USB-key action, so that we don't do duplicate download.",
                        "If this action fails, it means the servo usbkey already have required stable_version OS image cached."
                      ],
                      "conditions": [
                        {
                          "name": "Servo usbkey has stable image",
                          "docs": [
                            "Check if the usbkey has the stable_version OS image.",
                            "TODO: Collect data on the usual number of retries and tweak the default"
                          ],
                          "exec_name": "servo_usbkey_has_stable_image",
                          "exec_args": [
                            "retry_count:3",
                            "retry_interval:1",
                            "usb_file_check:true"
                          ],
                          "run_control": "RERUN_AFTER_RECOVERY"
                        }
                      ],
                      "exec_name": "sample_fail",
                      "run_control": "RERUN_AFTER_RECOVERY"
                    }
                  ],
                  "dependencies": [
                    {
                      "name": "servo_servod_echo_host",
                      "exec_name": "servo_servod_echo_host",
                      "run_control": "RERUN_AFTER_RECOVERY"
                    },
                    {
                      "name": "Is servo USB key detected",
                      "docs": [
                        "The action used as codiion.",
                        "The action verify that USB-key is detected and readable."
                      ],
                      "dependencies": [
                        {
                          "name": "Is servod running",
                          "docs": [
                            "Verify that servo host specified in setup and servod is running."
                          ],
                          "dependencies": [
                            {
                              "name": "Setup has servo info",
                              "exec_name": "dut_servo_host_present",
                              "run_control": "RERUN_AFTER_RECOVERY"
                            },
                            {
                              "name": "Verify servod is responsive",
                              "conditions": [
                                {
                                  "name": "Setup has servo info",
                                  "exec_name": "dut_servo_host_present",
                                  "run_control": "RERUN_AFTER_RECOVERY"
                                }
                              ],
                              "exec_name": "servod_echo",
                              "exec_args": [
                                "ssh_check:false"
                              ],
                              "timeout": "10s",
                              "run_control": "ALWAYS_RUN"
                            }
                          ],
                          "exec_name": "sample_pass",
                          "run_control": "RERUN_AFTER_RECOVERY"
                        }
                      ],
                      "exec_name": "servo_usbkey_is_detected",
                      "exec_args": [
                        "file_check:true"
                      ],
                      "run_control": "RERUN_AFTER_RECOVERY"
                    },
                    {
                      "name": "Call servod to download image to USB-key",
                      "docs": [
                        "This action calls servod to download stable version OS image to servo USB-key."
                      ],
                      "exec_name": "servo_download_image_to_usb",
                      "timeout": "50m0s",
                      "run_control": "ALWAYS_RUN"
                    },
                    {
                      "name": "Remove UPDATE_USBKEY_IMAGE repair-request",
                      "docs": [
                        "Remove UPDATE_USBKEY_IMAGE from repair-requests."
                      ],
                      "exec_name": "dut_remove_repair_requests",
                      "exec_args": [
                        "requests:UPDATE_USBKEY_IMAGE"
                      ],
                      "run_control": "ALWAYS_RUN"
                    }
                  ],
                  "exec_name": "sample_pass",
                  "allow_fail_after_recovery": true,
                  "run_control": "RUN_ONCE"
                },
                {
                  "name": "Power OFF DUT by servo",
                  "docs": [
                    "Turn DUT OFF by servo and do not wait."
                  ],
                  "dependencies": [
                    {
                      "name": "Is servod running",
                      "docs": [
                        "Verify that servo host specified in setup and servod is running."
                      ],
                      "dependencies": [
                        {
                          "name": "Setup has servo info",
                          "exec_name": "dut_servo_host_present",
                          "run_control": "RERUN_AFTER_RECOVERY"
                        },
                        {
                          "name": "Verify servod is responsive",
                          "conditions": [
                            {
                              "name": "Setup has servo info",
                              "exec_name": "dut_servo_host_present",
                              "run_control": "RERUN_AFTER_RECOVERY"
                            }
                          ],
                          "exec_name": "servod_echo",
                          "exec_args": [
                            "ssh_check:false"
                          ],
                          "timeout": "10s",
                          "run_control": "ALWAYS_RUN"
                        }
                      ],
                      "exec_name": "sample_pass",
                      "run_control": "RERUN_AFTER_RECOVERY"
                    }
                  ],
                  "exec_name": "servo_set",
                  "exec_args": [
                    "command:power_state",
                    "string_value:off",
                    "timeout:30"
                  ],
                  "run_control": "ALWAYS_RUN"
                },
                {
                  "name": "Direct USB-drive to DUT",
                  "docs": [
                    "Switch servo's USB-drive to point to DUT."
                  ],
                  "dependencies": [
                    {
                      "name": "Is servod running",
                      "docs": [
                        "Verify that servo host specified in setup and servod is running."
                      ],
                      "dependencies": [
                        {
                          "name": "Setup has servo info",
                          "exec_name": "dut_servo_host_present",
                          "run_control": "RERUN_AFTER_RECOVERY"
                        },
                        {
                          "name": "Verify servod is responsive",
                          "conditions": [
                            {
                              "name": "Setup has servo info",
                              "exec_name": "dut_servo_host_present",
                              "run_control": "RERUN_AFTER_RECOVERY"
                            }
                          ],
                          "exec_name": "servod_echo",
                          "exec_args": [
                            "ssh_check:false"
                          ],
                          "timeout": "10s",
                          "run_control": "ALWAYS_RUN"
                        }
                      ],
                      "exec_name": "sample_pass",
                      "run_control": "RERUN_AFTER_RECOVERY"
                    }
                  ],
                  "exec_name": "servo_set",
                  "exec_args": [
                    "command:image_usbkey_direction",
                    "string_value:dut_sees_usbkey"
                  ],
                  "timeout": "20s",
                  "run_control": "ALWAYS_RUN"
                },
                {
                  "name": "Sleep 10 seconds",
                  "exec_name": "sample_sleep",
                  "exec_args": [
                    "sleep:10"
                  ],
                  "timeout": "11s",
                  "allow_fail_after_recovery": true,
                  "run_control": "ALWAYS_RUN"
                },
                {
                  "name": "Power ON DUT by servo",
                  "docs": [
                    "Turn DUT ON by servo and do not wait."
                  ],
                  "dependencies": [
                    {
                      "name": "Is servod running",
                      "docs": [
                        "Verify that servo host specified in setup and servod is running."
                      ],
                      "dependencies": [
                        {
                          "name": "Setup has servo info",
                          "exec_name": "dut_servo_host_present",
                          "run_control": "RERUN_AFTER_RECOVERY"
                        },
                        {
                          "name": "Verify servod is responsive",
                          "conditions": [
                            {
                              "name": "Setup has servo info",
                              "exec_name": "dut_servo_host_present",
                              "run_control": "RERUN_AFTER_RECOVERY"
                            }
                          ],
                          "exec_name": "servod_echo",
                          "exec_args": [
                            "ssh_check:false"
                          ],
                          "timeout": "10s",
                          "run_control": "ALWAYS_RUN"
                        }
                      ],
                      "exec_name": "sample_pass",
                      "run_control": "RERUN_AFTER_RECOVERY"
                    }
                  ],
                  "exec_name": "servo_set",
                  "exec_args": [
                    "command:power_state",
                    "string_value:on"
                  ],
                  "run_control": "ALWAYS_RUN"
                },
                {
                  "name": "Sleep 10 seconds",
                  "exec_name": "sample_sleep",
                  "exec_args": [
                    "sleep:10"
                  ],
                  "timeout": "11s",
                  "allow_fail_after_recovery": true,
                  "run_control": "ALWAYS_RUN"
                },
                {
                  "name": "Wait to be SSHable (normal boot)",
                  "docs": [
                    "Try to wait device to be sshable after the device being rebooted.",
                    "Waiting time 150 seconds."
                  ],
                  "exec_name": "cros_ssh",
                  "timeout": "2m30s",
                  "run_control": "ALWAYS_RUN"
                },
                {
                  "name": "Print active devices",
                  "docs": [
                    "Print active devices visible for DUT."
                  ],
                  "exec_name": "cros_run_command",
                  "exec_args": [
                    "host:dut",
                    "command:lsblk",
                    "background:false"
                  ],
                  "allow_fail_after_recovery": true,
                  "run_control": "ALWAYS_RUN"
                },
                {
                  "name": "Is Flex booted from USB-drive",
                  "docs": [
                    "Check if device booted from USB in installer mode."
                  ],
                  "conditions": [
                    {
                      "name": "Is Flex device",
                      "docs": [
                        "Check that DUT is a Flex board"
                      ],
                      "exec_name": "dut_check_board",
                      "exec_args": [
                        "string_values:aurora,reven",
                        "invert_result:false"
                      ],
                      "run_control": "RERUN_AFTER_RECOVERY"
                    }
                  ],
                  "exec_name": "cros_run_command",
                  "exec_args": [
                    "host:dut",
                    "command:is_running_from_installer |grep yes",
                    "background:false"
                  ],
                  "run_control": "ALWAYS_RUN"
                },
                {
                  "name": "Run chromeos-install for Flex",
                  "docs": [
                    "Run chromeos-install for Flex DUTs with detecting destination.",
                    "Flex device does not detect destination as part of chromeos-install script."
                  ],
                  "dependencies": [
                    {
                      "name": "Is Flex device",
                      "docs": [
                        "Check that DUT is a Flex board"
                      ],
                      "exec_name": "dut_check_board",
                      "exec_args": [
                        "string_values:aurora,reven",
                        "invert_result:false"
                      ],
                      "run_control": "RERUN_AFTER_RECOVERY"
                    }
                  ],
                  "exec_name": "cros_run_command",
                  "exec_args": [
                    "host:dut",
                    "command:chromeos-install --dst $(lsblk --bytes --output NAME  --paths -I 259 -n -d) --yes",
                    "background:false"
                  ],
                  "timeout": "10m0s",
                  "run_control": "ALWAYS_RUN"
                },
                {
                  "name": "Sleep 10 seconds",
                  "exec_name": "sample_sleep",
                  "exec_args": [
                    "sleep:10"
                  ],
                  "timeout": "11s",
                  "allow_fail_after_recovery": true,
                  "run_control": "ALWAYS_RUN"
                },
                {
                  "name": "Power OFF DUT by servo",
                  "docs": [
                    "Turn DUT OFF by servo and do not wait."
                  ],
                  "dependencies": [
                    {
                      "name": "Is servod running",
                      "docs": [
                        "Verify that servo host specified in setup and servod is running."
                      ],
                      "dependencies": [
                        {
                          "name": "Setup has servo info",
                          "exec_name": "dut_servo_host_present",
                          "run_control": "RERUN_AFTER_RECOVERY"
                        },
                        {
                          "name": "Verify servod is responsive",
                          "conditions": [
                            {
                              "name": "Setup has servo info",
                              "exec_name": "dut_servo_host_present",
                              "run_control": "RERUN_AFTER_RECOVERY"
                            }
                          ],
                          "exec_name": "servod_echo",
                          "exec_args": [
                            "ssh_check:false"
                          ],
                          "timeout": "10s",
                          "run_control": "ALWAYS_RUN"
                        }
                      ],
                      "exec_name": "sample_pass",
                      "run_control": "RERUN_AFTER_RECOVERY"
                    }
                  ],
                  "exec_name": "servo_set",
                  "exec_args": [
                    "command:power_state",
                    "string_value:off",
                    "timeout:30"
                  ],
                  "run_control": "ALWAYS_RUN"
                },
                {
                  "name": "Direct USB-drive to servo host",
                  "docs": [
                    "Switch servo's USB-drive to point to servo-host."
                  ],
                  "dependencies": [
                    {
                      "name": "Is servod running",
                      "docs": [
                        "Verify that servo host specified in setup and servod is running."
                      ],
                      "dependencies": [
                        {
                          "name": "Setup has servo info",
                          "exec_name": "dut_servo_host_present",
                          "run_control": "RERUN_AFTER_RECOVERY"
                        },
                        {
                          "name": "Verify servod is responsive",
                          "conditions": [
                            {
                              "name": "Setup has servo info",
                              "exec_name": "dut_servo_host_present",
                              "run_control": "RERUN_AFTER_RECOVERY"
                            }
                          ],
                          "exec_name": "servod_echo",
                          "exec_args": [
                            "ssh_check:false"
                          ],
                          "timeout": "10s",
                          "run_control": "ALWAYS_RUN"
                        }
                      ],
                      "exec_name": "sample_pass",
                      "run_control": "RERUN_AFTER_RECOVERY"
                    }
                  ],
                  "exec_name": "servo_set",
                  "exec_args": [
                    "command:image_usbkey_direction",
                    "string_value:servo_sees_usbkey"
                  ],
                  "timeout": "20s",
                  "run_control": "ALWAYS_RUN"
                },
                {
                  "name": "Power ON DUT by servo",
                  "docs": [
                    "Turn DUT ON by servo and do not wait."
                  ],
                  "dependencies": [
                    {
                      "name": "Is servod running",
                      "docs": [
                        "Verify that servo host specified in setup and servod is running."
                      ],
                      "dependencies": [
                        {
                          "name": "Setup has servo info",
                          "exec_name": "dut_servo_host_present",
                          "run_control": "RERUN_AFTER_RECOVERY"
                        },
                        {
                          "name": "Verify servod is responsive",
                          "conditions": [
                            {
                              "name": "Setup has servo info",
                              "exec_name": "dut_servo_host_present",
                              "run_control": "RERUN_AFTER_RECOVERY"
                            }
                          ],
                          "exec_name": "servod_echo",
                          "exec_args": [
                            "ssh_check:false"
                          ],
                          "timeout": "10s",
                          "run_control": "ALWAYS_RUN"
                        }
                      ],
                      "exec_name": "sample_pass",
                      "run_control": "RERUN_AFTER_RECOVERY"
                    }
                  ],
                  "exec_name": "servo_set",
                  "exec_args": [
                    "command:power_state",
                    "string_value:on"
                  ],
                  "run_control": "ALWAYS_RUN"
                },
                {
                  "name": "Wait to be SSHable (normal boot)",
                  "docs": [
                    "Try to wait device to be sshable after the device being rebooted.",
                    "Waiting time 150 seconds."
                  ],
                  "exec_name": "cros_ssh",
                  "timeout": "2m30s",
                  "run_control": "ALWAYS_RUN"
                }
              ],
              "exec_name": "sample_pass",
              "run_control": "ALWAYS_RUN"
            },
            {
              "name": "Install OS in DEV mode by USB-drive",
              "docs": [
                "This action installs the test image on DUT after booking the DUT in dev mode."
              ],
              "conditions": [
                {
                  "name": "Recovery version has OS image path",
                  "docs": [
                    "Verify that recovery version has OS image path."
                  ],
                  "dependencies": [
                    {
                      "name": "Has a stable-version service",
                      "docs": [
                        "Verify if we have access to the service provided access to the stable version"
                      ],
                      "exec_name": "has_stable_version_service_path",
                      "run_control": "RUN_ONCE"
                    }
                  ],
                  "exec_name": "has_stable_version_cros_image",
                  "run_control": "RERUN_AFTER_RECOVERY"
                },
                {
                  "name": "Is servod running",
                  "docs": [
                    "Verify that servo host specified in setup and servod is running."
                  ],
                  "dependencies": [
                    {
                      "name": "Setup has servo info",
                      "exec_name": "dut_servo_host_present",
                      "run_control": "RERUN_AFTER_RECOVERY"
                    },
                    {
                      "name": "Verify servod is responsive",
                      "conditions": [
                        {
                          "name": "Setup has servo info",
                          "exec_name": "dut_servo_host_present",
                          "run_control": "RERUN_AFTER_RECOVERY"
                        }
                      ],
                      "exec_name": "servod_echo",
                      "exec_args": [
                        "ssh_check:false"
                      ],
                      "timeout": "10s",
                      "run_control": "ALWAYS_RUN"
                    }
                  ],
                  "exec_name": "sample_pass",
                  "run_control": "RERUN_AFTER_RECOVERY"
                },
                {
                  "name": "Is not Flex device",
                  "docs": [
                    "Check that DUT is not a Flex board"
                  ],
                  "exec_name": "dut_check_board",
                  "exec_args": [
                    "string_values:aurora,reven",
                    "invert_result:true"
                  ],
                  "run_control": "RERUN_AFTER_RECOVERY"
                },
                {
                  "name": "Is servo USB key detected",
                  "docs": [
                    "The action used as codiion.",
                    "The action verify that USB-key is detected and readable."
                  ],
                  "dependencies": [
                    {
                      "name": "Is servod running",
                      "docs": [
                        "Verify that servo host specified in setup and servod is running."
                      ],
                      "dependencies": [
                        {
                          "name": "Setup has servo info",
                          "exec_name": "dut_servo_host_present",
                          "run_control": "RERUN_AFTER_RECOVERY"
                        },
                        {
                          "name": "Verify servod is responsive",
                          "conditions": [
                            {
                              "name": "Setup has servo info",
                              "exec_name": "dut_servo_host_present",
                              "run_control": "RERUN_AFTER_RECOVERY"
                            }
                          ],
                          "exec_name": "servod_echo",
                          "exec_args": [
                            "ssh_check:false"
                          ],
                          "timeout": "10s",
                          "run_control": "ALWAYS_RUN"
                        }
                      ],
                      "exec_name": "sample_pass",
                      "run_control": "RERUN_AFTER_RECOVERY"
                    }
                  ],
                  "exec_name": "servo_usbkey_is_detected",
                  "exec_args": [
                    "file_check:true"
                  ],
                  "run_control": "RERUN_AFTER_RECOVERY"
                }
              ],
              "dependencies": [
                {
                  "name": "Boot DUT from USB in DEV mode",
                  "docs": [
                    "Restart and try to boot from USB-drive",
                    "First boot in dev mode can take time so set boot time to 10 minutes."
                  ],
                  "dependencies": [
                    {
                      "name": "Setup has servo info",
                      "exec_name": "dut_servo_host_present",
                      "run_control": "RERUN_AFTER_RECOVERY"
                    }
                  ],
                  "exec_name": "cros_dev_mode_boot_from_servo_usb_drive",
                  "exec_args": [
                    "boot_retry:2",
                    "boot_timeout:600",
                    "retry_interval:1",
                    "verify_usbkey_boot:true"
                  ],
                  "timeout": "10m50s",
                  "run_control": "ALWAYS_RUN"
                },
                {
                  "name": "Run install after boot from USB-drive",
                  "docs": [
                    "Perform install process when device booted from USB-drive."
                  ],
                  "exec_name": "cros_run_chromeos_install_command_after_boot_usbdrive",
                  "timeout": "20m0s",
                  "run_control": "ALWAYS_RUN"
                },
                {
                  "name": "Cold reset DUT by servo and wait to boot",
                  "docs": [
                    "Cold reset device by servo and wait for DUT to become ping-able."
                  ],
                  "conditions": [
                    {
                      "name": "Is servod running",
                      "docs": [
                        "Verify that servo host specified in setup and servod is running."
                      ],
                      "dependencies": [
                        {
                          "name": "Setup has servo info",
                          "exec_name": "dut_servo_host_present",
                          "run_control": "RERUN_AFTER_RECOVERY"
                        },
                        {
                          "name": "Verify servod is responsive",
                          "conditions": [
                            {
                              "name": "Setup has servo info",
                              "exec_name": "dut_servo_host_present",
                              "run_control": "RERUN_AFTER_RECOVERY"
                            }
                          ],
                          "exec_name": "servod_echo",
                          "exec_args": [
                            "ssh_check:false"
                          ],
                          "timeout": "10s",
                          "run_control": "ALWAYS_RUN"
                        }
                      ],
                      "exec_name": "sample_pass",
                      "run_control": "RERUN_AFTER_RECOVERY"
                    }
                  ],
                  "dependencies": [
                    {
                      "name": "Cold reset DUT by servo",
                      "docs": [
                        "Cold reset device by servo and do not wait."
                      ],
                      "dependencies": [
                        {
                          "name": "Is servod running",
                          "docs": [
                            "Verify that servo host specified in setup and servod is running."
                          ],
                          "dependencies": [
                            {
                              "name": "Setup has servo info",
                              "exec_name": "dut_servo_host_present",
                              "run_control": "RERUN_AFTER_RECOVERY"
                            },
                            {
                              "name": "Verify servod is responsive",
                              "conditions": [
                                {
                                  "name": "Setup has servo info",
                                  "exec_name": "dut_servo_host_present",
                                  "run_control": "RERUN_AFTER_RECOVERY"
                                }
                              ],
                              "exec_name": "servod_echo",
                              "exec_args": [
                                "ssh_check:false"
                              ],
                              "timeout": "10s",
                              "run_control": "ALWAYS_RUN"
                            }
                          ],
                          "exec_name": "sample_pass",
                          "run_control": "RERUN_AFTER_RECOVERY"
                        }
                      ],
                      "exec_name": "servo_set",
                      "exec_args": [
                        "command:power_state",
                        "string_value:reset",
                        "timeout:30"
                      ],
                      "run_control": "ALWAYS_RUN"
                    },
                    {
                      "name": "Wait to be pingable (normal boot)",
                      "docs": [
                        "Wait DUT to be pingable after some action on it.",
                        "Waiting time 150 seconds."
                      ],
                      "exec_name": "cros_ping",
                      "timeout": "2m30s",
                      "run_control": "ALWAYS_RUN"
                    }
                  ],
                  "exec_name": "sample_pass",
                  "run_control": "ALWAYS_RUN"
                },
                {
                  "name": "Wait to be SSHable (normal boot)",
                  "docs": [
                    "Try to wait device to be sshable after the device being rebooted.",
                    "Waiting time 150 seconds."
                  ],
                  "exec_name": "cros_ssh",
                  "timeout": "2m30s",
                  "run_control": "ALWAYS_RUN"
                },
                {
                  "name": "Remove REIMAGE_BY_USBKEY repair-request",
                  "docs": [
                    "Remove REIMAGE_BY_USBKEY and PROVISION repair-requests."
                  ],
                  "exec_name": "dut_remove_repair_requests",
                  "exec_args": [
                    "requests:PROVISION,REIMAGE_BY_USBKEY"
                  ],
                  "run_control": "ALWAYS_RUN"
                }
              ],
              "exec_name": "sample_pass",
              "run_control": "ALWAYS_RUN"
            },
            {
              "name": "Reset power using servo if booted from USB",
              "docs": [
                "This action will reboot the DUT using servo if device ",
                "is not booted after off/on performed as part of ",
                "re-imaging the device from USB device."
              ],
              "conditions": [
                {
                  "name": "Is servod running",
                  "docs": [
                    "Verify that servo host specified in setup and servod is running."
                  ],
                  "dependencies": [
                    {
                      "name": "Setup has servo info",
                      "exec_name": "dut_servo_host_present",
                      "run_control": "RERUN_AFTER_RECOVERY"
                    },
                    {
                      "name": "Verify servod is responsive",
                      "conditions": [
                        {
                          "name": "Setup has servo info",
                          "exec_name": "dut_servo_host_present",
                          "run_control": "RERUN_AFTER_RECOVERY"
                        }
                      ],
                      "exec_name": "servod_echo",
                      "exec_args": [
                        "ssh_check:false"
                      ],
                      "timeout": "10s",
                      "run_control": "ALWAYS_RUN"
                    }
                  ],
                  "exec_name": "sample_pass",
                  "run_control": "RERUN_AFTER_RECOVERY"
                }
              ],
              "dependencies": [
                {
                  "name": "Cold reset DUT by servo",
                  "docs": [
                    "Cold reset device by servo and do not wait."
                  ],
                  "dependencies": [
                    {
                      "name": "Is servod running",
                      "docs": [
                        "Verify that servo host specified in setup and servod is running."
                      ],
                      "dependencies": [
                        {
                          "name": "Setup has servo info",
                          "exec_name": "dut_servo_host_present",
                          "run_control": "RERUN_AFTER_RECOVERY"
                        },
                        {
                          "name": "Verify servod is responsive",
                          "conditions": [
                            {
                              "name": "Setup has servo info",
                              "exec_name": "dut_servo_host_present",
                              "run_control": "RERUN_AFTER_RECOVERY"
                            }
                          ],
                          "exec_name": "servod_echo",
                          "exec_args": [
                            "ssh_check:false"
                          ],
                          "timeout": "10s",
                          "run_control": "ALWAYS_RUN"
                        }
                      ],
                      "exec_name": "sample_pass",
                      "run_control": "RERUN_AFTER_RECOVERY"
                    }
                  ],
                  "exec_name": "servo_set",
                  "exec_args": [
                    "command:power_state",
                    "string_value:reset",
                    "timeout:30"
                  ],
                  "run_control": "ALWAYS_RUN"
                },
                {
                  "name": "Wait to be SSHable (normal boot)",
                  "docs": [
                    "Try to wait device to be sshable after the device being rebooted.",
                    "Waiting time 150 seconds."
                  ],
                  "exec_name": "cros_ssh",
                  "timeout": "2m30s",
                  "run_control": "ALWAYS_RUN"
                }
              ],
              "exec_name": "sample_pass",
              "run_control": "RERUN_AFTER_RECOVERY"
            }
          ],
          "run_control": "ALWAYS_RUN"
        },
        {
          "name": "Audit storage (SMART only)",
          "docs": [
            "Quick audit internal storage by reading SMART data.",
            "The check updates storage state.",
            "The check is not critical as update storage state."
          ],
          "exec_name": "cros_audit_storage_smart",
          "allow_fail_after_recovery": true,
          "run_control": "RERUN_AFTER_RECOVERY"
        },
        {
          "name": "Audit device storage using badblocks",
          "docs": [
            "Use the badblocks command to audit the storage on the DUT"
          ],
          "exec_name": "cros_audit_storage_bad_blocks",
          "exec_args": [
            "badblocks_mode:auto",
            "rw_badblocks_timeout:5400",
            "ro_badblocks_timeout:3600"
          ],
          "timeout": "1h40m0s",
          "allow_fail_after_recovery": true,
          "run_control": "RERUN_AFTER_RECOVERY"
        }
      ]
    },
    {
      "name": "close",
      "critical_actions": [
        {
          "name": "Update peripheral wifi state",
          "docs": [
            "Update peripheral wifi state based on wifi router states"
          ],
          "exec_name": "update_peripheral_wifi_state",
          "allow_fail_after_recovery": true,
          "run_control": "RERUN_AFTER_RECOVERY"
        },
        {
          "name": "Update wifi router features",
          "docs": [
            "Update wifi router features based on the features of all wifi routers"
          ],
          "exec_name": "update_wifi_router_features",
          "allow_fail_after_recovery": true,
          "run_control": "RERUN_AFTER_RECOVERY"
        },
        {
          "name": "Update chameleon state for chameleonless dut",
          "docs": [
            "Update chameleon state to not applicable for chameleonless dut"
          ],
          "conditions": [
            {
              "name": "chameleon_not_present",
              "exec_name": "chameleon_not_present",
              "run_control": "RERUN_AFTER_RECOVERY"
            }
          ],
          "exec_name": "chameleon_state_not_applicable",
          "allow_fail_after_recovery": true,
          "run_control": "RERUN_AFTER_RECOVERY"
        },
        {
          "name": "Update DUT state based on servo state",
          "docs": [
            "Set the DUT state based on the state of servo. ",
            "This applies only if the count of failures is ",
            "not above a threshold amount"
          ],
          "conditions": [
            {
              "name": "DUT state is repair_failed",
              "docs": [
                "Check if the DUT's state is in repair_failed state, if not then fail."
              ],
              "exec_name": "dut_state_match",
              "exec_args": [
                "state:repair_failed"
              ],
              "run_control": "RERUN_AFTER_RECOVERY"
            },
            {
              "name": "Failure count are not above threshold",
              "docs": [
                "Check if the number of times the recovery task ",
                "has failed is not greater than a threshold value"
              ],
              "dependencies": [
                {
                  "name": "Failure count above threshold",
                  "docs": [
                    "Check if the number of times the recovery task ",
                    "has failed is greater than a threshold value or ",
                    "not."
                  ],
                  "conditions": [
                    {
                      "name": "Is not Flex device",
                      "docs": [
                        "Verify that device is belong Reven models"
                      ],
                      "exec_name": "dut_check_board",
                      "exec_args": [
                        "string_values:aurora,reven",
                        "invert_result:true"
                      ],
                      "run_control": "RERUN_AFTER_RECOVERY"
                    }
                  ],
                  "exec_name": "metrics_check_task_failures",
                  "exec_args": [
                    "task_name:recovery",
                    "repair_failed_count:6"
                  ],
                  "run_control": "RERUN_AFTER_RECOVERY"
                }
              ],
              "exec_name": "sample_fail",
              "run_control": "RERUN_AFTER_RECOVERY"
            },
            {
              "name": "Servo-host known",
              "exec_name": "dut_servo_host_present",
              "run_control": "RERUN_AFTER_RECOVERY"
            },
            {
              "name": "Servo state demands manual repair",
              "docs": [
                "Check whether the state of servo mandates a ",
                "manual repair on the DUT."
              ],
              "exec_name": "dut_servo_state_required_manual_attention",
              "exec_args": [
                "servo_states:NEED_REPLACEMENT,DUT_NOT_CONNECTED"
              ],
              "run_control": "RERUN_AFTER_RECOVERY"
            },
            {
              "name": "Set state: needs_manual_repair",
              "docs": [
                "Set DUT state as needs_manual_repair."
              ],
              "exec_name": "dut_set_state",
              "exec_args": [
                "state:needs_manual_repair"
              ],
              "allow_fail_after_recovery": true,
              "run_control": "ALWAYS_RUN"
            }
          ],
          "exec_name": "dut_set_state_reason",
          "exec_args": [
            "allow_override:false",
            "reason:CRITICAL_SERVO_ISSUE"
          ],
          "run_control": "RERUN_AFTER_RECOVERY"
        },
        {
          "name": "Update DUT state for failures more than threshold",
          "docs": [
            "Set the DUT state to the value passed in the ",
            "extra args."
          ],
          "conditions": [
            {
              "name": "DUT state is repair_failed",
              "docs": [
                "Check if the DUT's state is in repair_failed state, if not then fail."
              ],
              "exec_name": "dut_state_match",
              "exec_args": [
                "state:repair_failed"
              ],
              "run_control": "RERUN_AFTER_RECOVERY"
            },
            {
              "name": "Failure count above threshold",
              "docs": [
                "Check if the number of times the recovery task ",
                "has failed is greater than a threshold value or ",
                "not."
              ],
              "conditions": [
                {
                  "name": "Is not Flex device",
                  "docs": [
                    "Verify that device is belong Reven models"
                  ],
                  "exec_name": "dut_check_board",
                  "exec_args": [
                    "string_values:aurora,reven",
                    "invert_result:true"
                  ],
                  "run_control": "RERUN_AFTER_RECOVERY"
                }
              ],
              "exec_name": "metrics_check_task_failures",
              "exec_args": [
                "task_name:recovery",
                "repair_failed_count:6"
              ],
              "run_control": "RERUN_AFTER_RECOVERY"
            },
            {
              "name": "Failure count above threshold (Flex)",
              "docs": [
                "Check if the number of times the recovery task ",
                "has failed is greater than a threshold value or ",
                "not."
              ],
              "conditions": [
                {
                  "name": "Is Flex device",
                  "docs": [
                    "Verify that device is belong Reven models"
                  ],
                  "exec_name": "dut_check_board",
                  "exec_args": [
                    "string_values:aurora,reven"
                  ],
                  "run_control": "RERUN_AFTER_RECOVERY"
                }
              ],
              "exec_name": "metrics_check_task_failures",
              "exec_args": [
                "task_name:recovery",
                "repair_failed_count:3"
              ],
              "run_control": "RERUN_AFTER_RECOVERY"
            },
            {
              "name": "Set state: needs_manual_repair",
              "docs": [
                "Set DUT state as needs_manual_repair."
              ],
              "exec_name": "dut_set_state",
              "exec_args": [
                "state:needs_manual_repair"
              ],
              "allow_fail_after_recovery": true,
              "run_control": "ALWAYS_RUN"
            }
          ],
          "exec_name": "dut_set_state_reason",
          "exec_args": [
            "allow_override:false",
            "reason:REPAIR_RETRY_REACHED_THRESHOLD"
          ],
          "run_control": "RERUN_AFTER_RECOVERY"
        },
        {
          "name": "Update cellular modem state for non-cellular pools",
          "docs": [
            "Set cellular modem state for DUTs in non-cellular pools."
          ],
          "conditions": [
            {
              "name": "Is not in cellular pool",
              "docs": [
                "Verify that DUT is not in a cellular pool."
              ],
              "exec_name": "dut_not_in_pool_regex",
              "exec_args": [
                "regex:(?i)^cellular"
              ],
              "run_control": "RERUN_AFTER_RECOVERY"
            },
            {
              "name": "has_cellular_info",
              "exec_name": "has_cellular_info",
              "run_control": "RERUN_AFTER_RECOVERY"
            }
          ],
          "exec_name": "set_cellular_modem_state",
          "exec_args": [
            "state:hardware_not_detected"
          ],
          "allow_fail_after_recovery": true,
          "run_control": "RERUN_AFTER_RECOVERY"
        },
        {
          "name": "Close Servo-host",
          "conditions": [
            {
              "name": "Servo-host known",
              "exec_name": "dut_servo_host_present",
              "run_control": "RERUN_AFTER_RECOVERY"
            },
            {
              "name": "Is not Flex device",
              "docs": [
                "Verify that device is belong Reven models"
              ],
              "exec_name": "dut_check_board",
              "exec_args": [
                "string_values:aurora,reven",
                "invert_result:true"
              ],
              "run_control": "RERUN_AFTER_RECOVERY"
            },
            {
              "name": "Servo-host is sshable",
              "docs": [
                "Stop the servod daemon.",
                "Allowed to fail as can be run when servod is not running."
              ],
              "exec_name": "cros_ssh",
              "exec_args": [
                "device_type:servo"
              ],
              "timeout": "15s",
              "run_control": "ALWAYS_RUN"
            }
          ],
          "dependencies": [
            {
              "name": "Try copy messages from servo-host",
              "docs": [
                "Try to collect /var/log/messages from servo-host."
              ],
              "conditions": [
                {
                  "name": "Servo-host known",
                  "exec_name": "dut_servo_host_present",
                  "run_control": "RERUN_AFTER_RECOVERY"
                }
              ],
              "exec_name": "cros_copy_to_logs",
              "exec_args": [
                "src_host_type:servo_host",
                "src_path:/var/log/messages",
                "src_type:file",
                "use_host_dir:true"
              ],
              "allow_fail_after_recovery": true,
              "run_control": "RERUN_AFTER_RECOVERY"
            },
            {
              "name": "Try to collect servod logs",
              "docs": [
                "Try to collect all servod logs since latest start time."
              ],
              "conditions": [
                {
                  "name": "Servo-host known",
                  "exec_name": "dut_servo_host_present",
                  "run_control": "RERUN_AFTER_RECOVERY"
                }
              ],
              "exec_name": "cros_collect_servod_logs",
              "allow_fail_after_recovery": true,
              "run_control": "RERUN_AFTER_RECOVERY"
            },
            {
              "name": "Remove in-use flag on servo-host",
              "conditions": [
                {
                  "name": "Servo-host known",
                  "exec_name": "dut_servo_host_present",
                  "run_control": "RERUN_AFTER_RECOVERY"
                }
              ],
              "exec_name": "cros_remove_servo_in_use",
              "allow_fail_after_recovery": true,
              "run_control": "RERUN_AFTER_RECOVERY"
            },
            {
              "name": "Remove request to reboot if servo is good",
              "conditions": [
                {
                  "name": "Is not Flex device",
                  "docs": [
                    "Verify that device is belong Reven models"
                  ],
                  "exec_name": "dut_check_board",
                  "exec_args": [
                    "string_values:aurora,reven",
                    "invert_result:true"
                  ],
                  "run_control": "RERUN_AFTER_RECOVERY"
                },
                {
                  "name": "Servo-host known",
                  "exec_name": "dut_servo_host_present",
                  "run_control": "RERUN_AFTER_RECOVERY"
                },
                {
                  "name": "Is servo_state:working",
                  "docs": [
                    "check the servo's state is ServoStateWorking."
                  ],
                  "exec_name": "servo_match_state",
                  "exec_args": [
                    "state:WORKING"
                  ],
                  "run_control": "RERUN_AFTER_RECOVERY"
                }
              ],
              "exec_name": "cros_remove_reboot_request",
              "allow_fail_after_recovery": true,
              "run_control": "RERUN_AFTER_RECOVERY"
            },
            {
              "name": "Turn off servo usbkey power",
              "docs": [
                "Ensure that servo usbkey power is in off state."
              ],
              "conditions": [
                {
                  "name": "Servo-host known",
                  "exec_name": "dut_servo_host_present",
                  "run_control": "RERUN_AFTER_RECOVERY"
                }
              ],
              "exec_name": "servo_set",
              "exec_args": [
                "command:image_usbkey_pwr",
                "string_value:off"
              ],
              "allow_fail_after_recovery": true,
              "run_control": "ALWAYS_RUN"
            },
            {
              "name": "Stop servod",
              "docs": [
                "Stop the servod daemon.",
                "Allowed to fail as can be run when servod is not running."
              ],
              "dependencies": [
                {
                  "name": "Save UART capture",
                  "dependencies": [
                    {
                      "name": "Stop UART capture",
                      "exec_name": "servod_stop_uart_capture",
                      "allow_fail_after_recovery": true,
                      "run_control": "RERUN_AFTER_RECOVERY"
                    }
                  ],
                  "exec_name": "servod_save_uart_capture",
                  "allow_fail_after_recovery": true,
                  "run_control": "RERUN_AFTER_RECOVERY"
                }
              ],
              "exec_name": "servo_host_servod_stop",
              "allow_fail_after_recovery": true,
              "run_control": "ALWAYS_RUN"
            }
          ],
          "exec_name": "sample_pass",
          "allow_fail_after_recovery": true,
          "run_control": "RERUN_AFTER_RECOVERY"
        }
      ],
      "allow_fail": true
    }
  ]
}